<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シフト提出フォーム (GAS連携テスト)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .time-slot { min-width: 45px; font-size: 0.8rem; }
        .date-label { min-width: 90px; font-size: 0.85rem; writing-mode: horizontal-tb; }

        /* テーブルヘッダー行のコンテナ(thead)のスティッキー設定 */
        .sticky-header-container { /* thead に適用 */
            position: -webkit-sticky; /* Safari対応 */
            position: sticky;
            top: 0;
            z-index: 20; /* tbodyのセルより手前 */
            /* background-colorはHTMLのTailwindクラス(bg-gray-100)で指定 */
        }

        /* ヘッダー行内のすべてのセル (th) */
        .sticky-header-container th {
            position: -webkit-sticky; /* Safari対応 */
            position: sticky;
            top: 0; /* ヘッダーセルも個別にtop:0で固定 */
            z-index: 25; /* theadのz-indexより少し高く、日付列のtdより確実に上 */
            /* background-colorはHTMLのTailwindクラス(bg-gray-100)で指定されることを期待 */
        }

        /* 日付列のヘッダーセル (左上) - z-indexを最上位に */
        .sticky-header-container > tr > th.sticky-col {
            left: 0; /* 左にも固定 */
            z-index: 30; /* 他のどのヘッダーセルよりも手前 */
             /* background-colorはHTMLのTailwindクラス(bg-gray-100)で指定 */
        }

        /* 日付列のボディセル (td) */
        tbody td.sticky-col {
            position: -webkit-sticky; /* Safari対応 */
            position: sticky;
            left: 0;
            z-index: 10; /* 通常のセルより手前、ヘッダーより奥 */
            /* background-colorはHTMLのTailwindクラスで指定 */
        }

        .selected { background-color: #3b82f6 !important; color: white !important; }
        .disabled-slot { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; font-style: italic; }
        .event-slot { background-color: #fef9c3; color: #713f12; }
        .event-slot.selected { background-color: #2563eb !important; color: white !important; }
        .saturday { color: #3b82f6; }
        .sunday { color: #ef4444; }
        .month-display-container { display: flex; align-items: center; justify-content: center; background-color: #e0f2fe; border-bottom: 1px solid #93c5fd; padding: 0.5rem 0; }
        .month-nav-button { background-color: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; margin: 0 1rem; border-radius: 0.375rem; cursor: pointer; font-weight: 500; }
        .month-nav-button:hover { background-color: #2563eb; }
        .month-display { text-align: center; font-size: 1.5rem; font-weight: 600; color: #1e40af; padding: 0.5rem 0; min-width: 150px; }
        .admin-section { background-color: #f3f4f6; border: 2px dashed #d1d5db; border-radius: 0.5rem; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden { display: none; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 p-2 md:p-4" style="font-family: 'Noto Sans JP', sans-serif;">
    <div class="container mx-auto max-w-5xl bg-white shadow-xl rounded-xl overflow-hidden">
        <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 text-center rounded-t-xl">
            <h1 class="text-2xl md:text-3xl font-bold">シフト提出システム</h1>
            <div id="loadingSpinner" class="loader hidden"></div>
            <p id="loadingStatus" class="text-sm text-blue-200 hidden"></p>
        </header>

        <section id="adminControlSection" class="p-4 md:p-6 admin-section m-4 rounded-lg">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">教室長用 設定パネル</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div>
                    <label for="eventDate" class="block text-sm font-medium text-gray-700">日付:</label>
                    <input type="date" id="eventDate" name="eventDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="eventTimeSlot" class="block text-sm font-medium text-gray-700">時間枠:</label>
                    <select id="eventTimeSlot" name="eventTimeSlot" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">選択してください</option>
                        <option value="全日">全日</option>
                        <option value="1限">1限</option><option value="2限">2限</option><option value="3限">3限</option><option value="4限">4限</option>
                        <option value="5限">5限</option><option value="6限">6限</option><option value="7限">7限</option><option value="8限">8限</option>
                    </select>
                </div>
                <div>
                    <label for="eventType" class="block text-sm font-medium text-gray-700">種別:</label>
                    <select id="eventType" name="eventType" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="講習">講習</option><option value="休講">休講</option><option value="その他">その他</option><option value="クリア">設定クリア</option>
                    </select>
                </div>
                <div>
                    <label for="eventDescription" class="block text-sm font-medium text-gray-700">詳細(任意):</label>
                    <input type="text" id="eventDescription" name="eventDescription" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="例: 数学特別講座">
                </div>
            </div>
            <div class="text-right">
                <button type="button" id="applyEventButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">設定を反映/保存</button>
                <button type="button" id="refreshAdminSettingsButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ml-2">最新の設定を読込</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">※設定はGoogleスプレッドシートに保存されます。</p>
        </section>

        <div class="month-display-container">
            <button id="prevMonthButton" class="month-nav-button">&lt; 前月</button>
            <div id="monthDisplay" class="month-display"></div>
            <button id="nextMonthButton" class="month-nav-button">次月 &gt;</button>
        </div>

        <div class="p-4 md:p-6">
            <p class="text-gray-700 mb-2 text-sm md:text-base">講師情報と勤務可能なコマをタップしてください。</p>
            <p class="text-xs text-gray-600 mb-6">
                <span class="inline-block w-3 h-3 bg-yellow-100 border border-gray-300 mr-1 align-middle"></span>講習/イベントコマ (選択可)
                <span class="inline-block w-3 h-3 bg-gray-200 border border-gray-300 ml-2 mr-1 align-middle"></span>休講コマ (選択不可)
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-8">
                <div>
                    <label for="instructorName" class="block text-sm font-medium text-gray-800 mb-1">講師氏名:</label>
                    <input type="text" id="instructorName" name="instructorName" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-shadow">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-800 mb-1">担当区分 (文理):</label>
                    <div class="mt-2 flex space-x-4">
                        <label class="inline-flex items-center"><input type="radio" name="subjectType" value="文系" class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500"><span class="ml-2 text-sm text-gray-700">文系</span></label>
                        <label class="inline-flex items-center"><input type="radio" name="subjectType" value="理系" class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500"><span class="ml-2 text-sm text-gray-700">理系</span></label>
                        <label class="inline-flex items-center"><input type="radio" name="subjectType" value="共通" checked class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500"><span class="ml-2 text-sm text-gray-700">共通</span></label>
                    </div>
                </div>
                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="targetYearMonth" class="block text-sm font-medium text-gray-800 mb-1">対象年月:</label>
                        <input type="month" id="targetYearMonth" name="targetYearMonth" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-shadow">
                    </div>
                    <div class="md:col-span-2">
                         <button type="button" id="loadShiftButton" class="w-full md:w-auto bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out">提出済みシフトを読み込む</button>
                    </div>
                </div>
                 </div>
            <div class="overflow-x-auto pb-4 shadow-md rounded-lg border border-gray-200">
                <table class="min-w-full border-collapse">
                    <thead class="sticky-header-container bg-gray-100">
                        <tr class="border-b border-gray-300">
                            <th class="sticky-col border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 date-label bg-gray-100">日付</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">1限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">2限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">3限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">4限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">5限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">6限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">7限</th>
                            <th class="bg-gray-100 border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">8限</th>
                        </tr>
                    </thead>
                    <tbody id="shiftTableBody" class="bg-white">
                        </tbody>
                </table>
            </div>
            <div class="mt-8">
                <label for="remarks" class="block text-sm font-medium text-gray-800 mb-1">備考:</label>
                <textarea id="remarks" name="remarks" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-shadow" placeholder="例: 〇日は17時まで勤務可能、〇週目は多めに入れます。"></textarea>
            </div>
            <div class="mt-10 mb-6 text-center">
                <button type="button" id="submitShiftButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-10 rounded-lg shadow-lg hover:shadow-xl transition duration-200 ease-in-out transform hover:scale-105">この内容で提出する</button>
                 <p id="submissionStatus" class="text-sm text-gray-600 mt-2 hidden"></p>
            </div>
        </div>
        <footer class="bg-gray-200 p-4 text-center text-xs md:text-sm text-gray-600 rounded-b-xl">
            &copy; <span id="currentYear"></span> Canvas 個別指導塾
        </footer>
    </div>

    <script>
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★ GASのウェブアプリURLをここに設定してください ★
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzf00GR1c0TwKdZl4baSLWHjuvOugDGd5c9ZNzLvnpdXoMa3FmQlkLsZGyDXn2ipigr/exec'; // ユーザーの実際のURLに置き換え済み
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

        document.addEventListener('DOMContentLoaded', function () {
            const tableBody = document.getElementById('shiftTableBody');
            const monthDisplay = document.getElementById('monthDisplay');
            const currentYearSpan = document.getElementById('currentYear');
            const instructorNameInput = document.getElementById('instructorName');
            const remarksInput = document.getElementById('remarks');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const loadingStatus = document.getElementById('loadingStatus');
            const submissionStatus = document.getElementById('submissionStatus'); // ★ 追加

            const eventDateInput = document.getElementById('eventDate');
            const eventTimeSlotSelect = document.getElementById('eventTimeSlot');
            const eventTypeSelect = document.getElementById('eventType');
            const eventDescriptionInput = document.getElementById('eventDescription');
            const applyEventButton = document.getElementById('applyEventButton');
            const refreshAdminSettingsButton = document.getElementById('refreshAdminSettingsButton');

            const prevMonthButton = document.getElementById('prevMonthButton');
            const nextMonthButton = document.getElementById('nextMonthButton');

            // ★★★ 年月選択とシフト読み込みボタンの要素を取得 ★★★
            const targetYearMonthInput = document.getElementById('targetYearMonth');
            const loadShiftButton = document.getElementById('loadShiftButton');
            // ★★★ 追加ここまで ★★★

            const today = new Date();
            let currentYear = today.getFullYear();
            let currentMonth = today.getMonth(); // 0-indexed
            let classroomEvents = {};
            let currentSubmissionId = null; // ★ 追加: 読み込んだシフトの提出IDを保持

            function showLoading(message = "処理中...") {
                loadingSpinner.classList.remove('hidden');
                loadingStatus.textContent = message;
                loadingStatus.classList.remove('hidden');
            }

            function hideLoading() {
                loadingSpinner.classList.add('hidden');
                loadingStatus.classList.add('hidden');
            }
            
            function formatDateKeyForStorage(dateObj) { 
                if (!(dateObj instanceof Date) || isNaN(dateObj)) { 
                    console.error("formatDateKeyForStorage: input is not a valid Date object", dateObj);
                    const d = new Date(); 
                    const year = d.getFullYear();
                    const month = (d.getMonth() + 1).toString().padStart(2, '0');
                    const dayVal = d.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${dayVal}`;
                }
                const year = dateObj.getFullYear();
                const month = (dateObj.getMonth() + 1).toString().padStart(2, '0'); // 1-indexed for storage key consistency
                const dayVal = dateObj.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${dayVal}`;
            }

            // ★★★ targetYearMonthInput の初期値を設定する関数 ★★★
            function setInitialTargetYearMonth() {
                const year = currentYear;
                const month = (currentMonth + 1).toString().padStart(2, '0'); // 1-indexed for input type="month"
                targetYearMonthInput.value = `${year}-${month}`;
            }
            // ★★★ 追加ここまで ★★★

            async function changeMonth(monthOffset) {
                currentMonth += monthOffset;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                } else if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                await loadAdminSettings(); // 教室長設定を読み込み直す
                const firstDayOfNewMonth = new Date(currentYear, currentMonth, 1);
                eventDateInput.value = formatDateKeyForStorage(firstDayOfNewMonth); // 教室長設定の日付も更新
                setInitialTargetYearMonth(); // ★ 講師用の年月選択も更新
                clearSelectionAndRemarks(); // ★ 月が変わったら選択状態と備考をクリア
                submissionStatus.classList.add('hidden'); // ★ 提出状態メッセージもクリア
                currentSubmissionId = null; // ★ 提出IDもクリア
            }

            prevMonthButton.addEventListener('click', function() {
                changeMonth(-1);
            });

            nextMonthButton.addEventListener('click', function() {
                changeMonth(1);
            });

            // ★★★ 年月選択が変更されたら、カレンダー表示もその年月に合わせる ★★★
            targetYearMonthInput.addEventListener('change', async function() {
                const [year, month] = this.value.split('-').map(Number);
                if (year && month) {
                    currentYear = year;
                    currentMonth = month - 1; // 0-indexed に変換
                    await loadAdminSettings(); // 教室長設定を読み込み直す
                    const firstDayOfNewMonth = new Date(currentYear, currentMonth, 1);
                    eventDateInput.value = formatDateKeyForStorage(firstDayOfNewMonth); // 教室長設定の日付も更新
                    clearSelectionAndRemarks(); // ★ 選択状態と備考をクリア
                    submissionStatus.classList.add('hidden'); // ★ 提出状態メッセージもクリア
                    currentSubmissionId = null; // ★ 提出IDもクリア
                }
            });
            // ★★★ 追加ここまで ★★★


            async function fetchFromGAS(action, payload = {}, method = 'GET') {
                console.log(`fetchFromGAS called. Action: ${action}, Method: ${method}, URL: ${GAS_WEB_APP_URL}`);
                if (method === 'POST') {
                    console.log('Payload for POST:', JSON.stringify(payload));
                }

                if (GAS_WEB_APP_URL === 'YOUR_GAS_WEB_APP_URL_HERE' || !GAS_WEB_APP_URL ) {
                    console.warn('GAS_WEB_APP_URL is a placeholder or not set. Simulating GAS response for preview.');
                     if (action === 'getAdminSettings' || action === 'loadShift') { // ★ loadShift を追加
                        hideLoading();
                        return Promise.resolve({ status: 'success', data: {} });
                    }
                    if (action === 'submitShift' || action === 'saveAdminSettings') {
                        hideLoading();
                        return Promise.resolve({ status: 'success', message: 'データはプレビューモードのため送信されませんが、処理はシミュレートされました。' });
                    }
                }

                showLoading(method === 'POST' ? 'データを送信中...' : 'データを読込中...');
                try {
                    let url = GAS_WEB_APP_URL;
                    const options = {
                        method: method,
                        mode: 'cors', 
                        redirect: 'follow',
                    };

                    if (method === 'GET') {
                        const params = new URLSearchParams(payload);
                        params.append('action', action);
                        // getAdminSettings の時だけ year と month を付与 (loadShiftではpayloadに含める)
                        if (action === 'getAdminSettings') {
                           params.append('year', currentYear); // populateShiftTableで使うcurrentYear
                           params.append('month', currentMonth + 1); // populateShiftTableで使うcurrentMonth (1-indexed)
                        }
                        url += '?' + params.toString();
                        console.log('GET request to:', url);
                    } else if (method === 'POST') {
                        payload.action = action; 
                        options.body = JSON.stringify(payload); 
                        options.headers = {
                            'Content-Type': 'text/plain;charset=UTF-8',
                        };
                        console.log('POST request to:', url, 'with options:', options);
                    }
                    
                    const response = await fetch(url, options);
                    console.log('Fetch response status:', response.status, 'Status text:', response.statusText);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Fetch response error text:', errorText); 
                        throw new Error(`GASへのリクエストに失敗しました。Status: ${response.status}, Message: ${errorText}`);
                    }
                    const responseText = await response.text();
                    console.log('Raw response text from GAS:', responseText);
                    try {
                        const result = JSON.parse(responseText);
                        console.log('Fetch result from GAS (parsed JSON):', result); 
                        if (result.status === 'error') {
                            throw new Error(`GASエラー: ${result.message}`);
                        }
                        return result;
                    } catch (e) {
                        console.error("Failed to parse GAS response as JSON:", e);
                        throw new Error("GASからの応答がJSON形式ではありません: " + responseText);
                    }
                } catch (error) {
                    console.error('GAS通信エラー (fetchFromGAS catch block):', error); 
                    alert(`エラーが発生しました: ${error.message}`);
                    throw error; 
                } finally {
                    hideLoading();
                }
            }

            async function loadAdminSettings() {
                try {
                    // getAdminSettings に渡す年月は、カレンダー表示用の currentYear と currentMonth を使う
                    const result = await fetchFromGAS('getAdminSettings', { year: currentYear, month: currentMonth + 1 }, 'GET');
                    classroomEvents = result.data || {};
                    populateShiftTable(); 
                    console.log(`教室長設定を読み込みました (${currentYear}年${currentMonth + 1}月):`, classroomEvents);
                } catch (error) {
                    console.error("loadAdminSettings でエラー:", error); 
                    classroomEvents = {}; 
                    populateShiftTable(); 
                }
            }
            
            function formatDateForDisplay(date) { 
                const d = new Date(date);
                const monthVal = d.getMonth() + 1; // 1-indexed for display
                const dayVal = d.getDate();
                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][d.getDay()];
                return `${monthVal}/${dayVal}(${dayOfWeek})`;
            }

            function populateShiftTable() {
                tableBody.innerHTML = '';
                // monthDisplay はカレンダー表示用の年月 (currentYear, currentMonth)
                monthDisplay.textContent = `${currentYear}年 ${currentMonth + 1}月`;
                currentYearSpan.textContent = currentYear;
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDateObj = new Date(currentYear, currentMonth, day); // currentMonth is 0-indexed
                    const dateKeyForLookup = formatDateKeyForStorage(currentDateObj); 
                    const dateForDisplay = formatDateForDisplay(currentDateObj); 

                    const dayOfWeekIndex = currentDateObj.getDay();
                    const row = document.createElement('tr');
                    row.classList.add('border-b', 'border-gray-200');
                    if (dayOfWeekIndex === 0 || dayOfWeekIndex === 6) row.classList.add('bg-gray-50');

                    const dateCell = document.createElement('td');
                    dateCell.classList.add('sticky-col', 'border-r', 'border-gray-300', 'px-2', 'py-3', 'text-xs', 'md:text-sm', 'text-gray-800', 'font-medium', 'date-label', 'text-center');
                    if (dayOfWeekIndex === 0) dateCell.classList.add('sunday');
                    if (dayOfWeekIndex === 6) dateCell.classList.add('saturday');
                    dateCell.classList.add((dayOfWeekIndex === 0 || dayOfWeekIndex === 6) ? 'bg-gray-50' : 'bg-white'); 
                    dateCell.textContent = dateForDisplay;
                    row.appendChild(dateCell);

                    for (let j = 1; j <= 8; j++) {
                        const timeSlotKey = `${j}限`;
                        const cell = document.createElement('td');
                        cell.classList.add('border-r', 'border-gray-300', 'px-1', 'py-3', 'text-center', 'cursor-pointer', 'time-slot-cell', 'transition-colors', 'duration-150');
                        if (j === 8) cell.classList.remove('border-r'); 

                        cell.dataset.date = dateForDisplay; // 表示用の日付 (M/D(曜))
                        cell.dataset.fullDate = dateKeyForLookup; // ★ YYYY-MM-DD形式の日付も保持
                        cell.dataset.timeSlot = timeSlotKey; 
                        
                        const settingId = `${dateKeyForLookup}_${timeSlotKey}`; 
                        const allDaySettingId = `${dateKeyForLookup}_全日`; 
                        
                        let eventInfo = classroomEvents[settingId];
                        if (!eventInfo && classroomEvents[allDaySettingId]) {
                            eventInfo = classroomEvents[allDaySettingId];
                        }

                        let originalText = "";
                        if (eventInfo) {
                            cell.dataset.eventType = eventInfo.type;
                            cell.dataset.eventDescription = eventInfo.description || ''; 
                            originalText = eventInfo.description ? `${eventInfo.type}(${eventInfo.description})` : eventInfo.type;
                            cell.innerHTML = `<span class="text-xs">${originalText}</span>`;
                            if (eventInfo.type === '休講') {
                                cell.classList.add('disabled-slot');
                                cell.title = `休講: ${eventInfo.description || ''}`;
                            } else {
                                cell.classList.add('event-slot');
                                cell.title = `${eventInfo.type}: ${eventInfo.description || ''}`;
                            }
                        }

                        if (!cell.classList.contains('disabled-slot')) {
                            cell.addEventListener('click', function() {
                                this.classList.toggle('selected');
                                if (this.classList.contains('selected')) {
                                    if (eventInfo) this.innerHTML = `<span class="text-xs">${originalText}</span>`; // イベント情報があれば再表示
                                } else {
                                    if (eventInfo) this.innerHTML = `<span class="text-xs">${originalText}</span>`; // イベント情報があれば再表示
                                    else this.innerHTML = ''; 
                                }
                            });
                        }
                        row.appendChild(cell);
                    }
                    tableBody.appendChild(row);
                }
            }

            applyEventButton.addEventListener('click', async function() {
                console.log('「設定を反映/保存」ボタンがクリックされました。');
                const dateVal = eventDateInput.value; 
                const timeSlotVal = eventTimeSlotSelect.value;
                const typeVal = eventTypeSelect.value;
                const descriptionVal = eventDescriptionInput.value;
                console.log('取得した値:', { dateVal, timeSlotVal, typeVal, descriptionVal });

                if (!dateVal || !timeSlotVal) {
                    alert('日付と時間枠を選択してください。');
                    console.log('日付または時間枠が未選択のため処理を中断。');
                    return;
                }
                
                const dateKey = formatDateKeyForStorage(new Date(dateVal)); 
                let updatedEventsForGAS = JSON.parse(JSON.stringify(classroomEvents)); 
                const settingIdBase = `${dateKey}_`;

                if (typeVal === 'クリア') {
                    console.log('イベントタイプ: クリア');
                    if (timeSlotVal === '全日') {
                        for (let i = 1; i <= 8; i++) delete updatedEventsForGAS[`${settingIdBase}${i}限`];
                        delete updatedEventsForGAS[`${settingIdBase}全日`];
                    } else {
                        delete updatedEventsForGAS[`${settingIdBase}${timeSlotVal}`];
                    }
                } else {
                    console.log('イベントタイプ:', typeVal); 
                    if (timeSlotVal === '全日') {
                        for (let i = 1; i <= 8; i++) delete updatedEventsForGAS[`${settingIdBase}${i}限`];
                        updatedEventsForGAS[`${settingIdBase}全日`] = { type: typeVal, description: descriptionVal };
                    } else {
                        delete updatedEventsForGAS[`${settingIdBase}全日`]; 
                        updatedEventsForGAS[`${settingIdBase}${timeSlotVal}`] = { type: typeVal, description: descriptionVal };
                    }
                }
                
                console.log('GASに送信する教室長設定 (updatedEventsForGAS):', JSON.stringify(updatedEventsForGAS));
                try {
                    // saveAdminSettings に渡す年月は、教室長設定が対象としている年月 (eventDateInputから取得した日付の年月)
                    const eventDateObj = new Date(dateVal);
                    const payloadYear = eventDateObj.getFullYear();
                    const payloadMonth = eventDateObj.getMonth() + 1; // 1-indexed

                    classroomEvents = updatedEventsForGAS; 
                    const result = await fetchFromGAS('saveAdminSettings', { events: classroomEvents, year: payloadYear, month: payloadMonth }, 'POST'); 
                    alert(result.message || '教室長設定をスプレッドシートに保存しました。');
                    await loadAdminSettings(); 
                } catch (error) {
                    console.error("applyEventButtonクリック処理でのエラー:", error); 
                    await loadAdminSettings(); 
                }
            });
            
            refreshAdminSettingsButton.addEventListener('click', async function() {
                if (confirm('スプレッドシートから最新の教室長設定を読み込みますか？未保存のローカル変更は失われます。')) {
                    await loadAdminSettings();
                    alert('最新の教室長設定を読み込みました。');
                }
            });

            // ★★★ 提出済みシフトを読み込む処理 ★★★
            loadShiftButton.addEventListener('click', async function() {
                const instructorName = instructorNameInput.value;
                const targetYearMonth = targetYearMonthInput.value; // YYYY-MM

                if (!instructorName) {
                    alert("講師氏名を入力してください。");
                    return;
                }
                if (!targetYearMonth) {
                    alert("対象年月を選択してください。");
                    return;
                }

                const [year, month] = targetYearMonth.split('-').map(Number);

                try {
                    submissionStatus.classList.add('hidden'); // 前回のメッセージをクリア
                    currentSubmissionId = null; // 提出IDをクリア
                    const result = await fetchFromGAS('loadShift', {
                        instructorName: instructorName,
                        year: year,
                        month: month // 1-indexed month
                    }, 'GET');

                    if (result.status === 'success' && result.data) {
                        const shiftData = result.data;
                        console.log('Loaded shift data:', shiftData);
                        
                        // フォームに読み込み
                        instructorNameInput.value = shiftData.instructorName;
                        const subjectRadio = document.querySelector(`input[name="subjectType"][value="${shiftData.subjectType}"]`);
                        if (subjectRadio) subjectRadio.checked = true;
                        remarksInput.value = shiftData.remarks || '';
                        currentSubmissionId = shiftData.submissionId || null; // ★ 提出IDを保持

                        // シフト表の選択状態をクリア
                        document.querySelectorAll('#shiftTableBody .time-slot-cell.selected').forEach(cell => {
                            cell.classList.remove('selected');
                            // イベント表示があるセルは元に戻す
                            const eventType = cell.dataset.eventType;
                            const eventDesc = cell.dataset.eventDescription;
                            if (eventType) {
                                cell.innerHTML = `<span class="text-xs">${eventDesc ? `${eventType}(${eventDesc})` : eventType}</span>`;
                            } else {
                                cell.innerHTML = '';
                            }
                        });

                        // 読み込んだシフトを選択状態にする
                        if (shiftData.shifts) {
                            Object.entries(shiftData.shifts).forEach(([dateStr, timeSlots]) => {
                                // dateStr は YYYY-MM-DD 形式であることを期待 (GAS側で整形)
                                timeSlots.forEach(slot => {
                                    const cell = document.querySelector(`#shiftTableBody .time-slot-cell[data-full-date="${dateStr}"][data-time-slot="${slot.timeSlot}"]`);
                                    if (cell && !cell.classList.contains('disabled-slot')) {
                                        cell.classList.add('selected');
                                        // イベント表示があるセルでも選択状態がわかるようにする（selectedクラスで背景色が変わるため、文字色はselectedのCSSで対応）
                                        const eventType = cell.dataset.eventType;
                                        const eventDesc = cell.dataset.eventDescription;
                                        if (eventType) {
                                            cell.innerHTML = `<span class="text-xs">${eventDesc ? `${eventType}(${eventDesc})` : eventType}</span>`;
                                        }
                                    }
                                });
                            });
                        }
                        submissionStatus.textContent = '提出済みのシフトを読み込みました。修正して再提出できます。';
                        submissionStatus.classList.remove('hidden');
                        alert('提出済みのシフトを読み込みました。');

                    } else if (result.status === 'success' && !result.data) {
                        submissionStatus.textContent = '指定された年月に提出済みのシフトはありませんでした。新規に作成できます。';
                        submissionStatus.classList.remove('hidden');
                        alert('提出済みのシフトはありませんでした。');
                        clearSelectionAndRemarks(false); // 講師名と担当区分は残す
                        currentSubmissionId = null;
                    } else {
                        submissionStatus.textContent = `エラー: ${result.message || 'シフトの読み込みに失敗しました。'}`;
                        submissionStatus.classList.remove('hidden');
                        alert(result.message || 'シフトの読み込みに失敗しました。');
                    }
                } catch (error) {
                    console.error("loadShiftButton でのエラー:", error);
                    alert('シフトの読み込み中にエラーが発生しました。');
                    submissionStatus.textContent = 'シフトの読み込み中にエラーが発生しました。';
                    submissionStatus.classList.remove('hidden');
                }
            });
            // ★★★ 追加ここまで ★★★

            // ★★★ 選択状態と備考欄をクリアする関数 ★★★
            function clearSelectionAndRemarks(clearInstructorInfo = true) {
                document.querySelectorAll('#shiftTableBody .time-slot-cell.selected').forEach(cell => {
                    cell.classList.remove('selected');
                    // イベント表示があるセルは元に戻す
                    const eventType = cell.dataset.eventType;
                    const eventDesc = cell.dataset.eventDescription;
                    if (eventType) {
                        cell.innerHTML = `<span class="text-xs">${eventDesc ? `${eventType}(${eventDesc})` : eventType}</span>`;
                    } else {
                        cell.innerHTML = '';
                    }
                });
                remarksInput.value = '';
                if (clearInstructorInfo) {
                    instructorNameInput.value = '';
                    document.querySelector('input[name="subjectType"][value="共通"]').checked = true;
                }
            }
            // ★★★ 追加ここまで ★★★


            const submitShiftButton = document.getElementById('submitShiftButton');
            submitShiftButton.addEventListener('click', async function handleSubmit() {
                console.log('「この内容で提出する」ボタンがクリックされました。');
                const instructorName = instructorNameInput.value;
                const subjectTypeElement = document.querySelector('input[name="subjectType"]:checked');
                const subjectType = subjectTypeElement ? subjectTypeElement.value : "";
                const remarks = remarksInput.value;
                const selectedCells = document.querySelectorAll('#shiftTableBody .time-slot-cell.selected');
                const targetYearMonth = targetYearMonthInput.value; // ★ YYYY-MM 形式

                if (!instructorName) { alert("講師氏名を入力してください。"); return; }
                if (!subjectType) { alert("担当区分（文理）を選択してください。"); return; }
                if (!targetYearMonth) { alert("対象年月を選択してください。"); return; } // ★ 追加

                const [year, month] = targetYearMonth.split('-').map(Number); // ★ 年と月を取得 (月は1-indexed)

                let shiftsData = {};
                selectedCells.forEach(cell => {
                    if (cell.classList.contains('disabled-slot')) return; 
                    
                    const fullDateKey = cell.dataset.fullDate; // ★ YYYY-MM-DD 形式を使用
                    const timeSlotKey = cell.dataset.timeSlot; 
                    let slotType = '通常'; 
                    let slotDescription = cell.dataset.eventDescription || '';

                    if (cell.classList.contains('event-slot') && cell.dataset.eventType) {
                        slotType = cell.dataset.eventType;
                    }

                    if (!shiftsData[fullDateKey]) {
                        shiftsData[fullDateKey] = [];
                    }
                    shiftsData[fullDateKey].push({
                        timeSlot: timeSlotKey,
                        type: slotType,
                        description: slotDescription
                    });
                });
                
                console.log('提出データ (shiftsData):', JSON.stringify(shiftsData));

                const dataToSubmit = {
                    submissionId: currentSubmissionId, // ★ 提出IDも送信 (新規ならnull)
                    year: year, 
                    month: month, // ★ 1-indexed month
                    instructorName: instructorName,
                    subjectType: subjectType,
                    remarks: remarks,
                    shifts: shiftsData, 
                };
                console.log('最終提出データ (dataToSubmit):', JSON.stringify(dataToSubmit));
                submissionStatus.classList.add('hidden'); // 前回のメッセージをクリア

                try {
                    const result = await fetchFromGAS('submitShift', dataToSubmit, 'POST');
                    submissionStatus.textContent = result.message || 'シフトが正常に送信されました。';
                    submissionStatus.classList.remove('hidden');
                    alert(result.message || 'シフトが正常に送信されました。');
                    
                    if (result.status === 'success') {
                        // 成功したらフォームを初期化するが、講師名と年月は残しても良いかもしれない
                        clearSelectionAndRemarks(true); // 全部クリアする場合
                        // clearSelectionAndRemarks(false); // 講師名と担当区分、年月は残す場合
                        // targetYearMonthInput.value = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}`; // 年月は現在のカレンダー表示に合わせる
                        currentSubmissionId = null; // 新規提出モードに戻る
                        // 必要であれば教室長設定も再読み込み (通常は不要)
                        // await loadAdminSettings(); 
                    }
                } catch (error) {
                    console.error("handleSubmit でのエラー:", error); 
                    submissionStatus.textContent = `エラー: ${error.message || 'シフトの提出に失敗しました。'}`;
                    submissionStatus.classList.remove('hidden');
                }
            });

            async function initialize() {
                console.log('Initializing application...'); 
                const urlParams = new URLSearchParams(window.location.search);
                const monthParam = urlParams.get('month'); 
                if (monthParam) {
                    const parts = monthParam.split('-');
                    if (parts.length === 2) {
                        const year = parseInt(parts[0]);
                        const monthVal = parseInt(parts[1]) - 1; // 0-indexed
                        if (!isNaN(year) && !isNaN(monthVal) && monthVal >= 0 && monthVal <= 11) {
                            currentYear = year;
                            currentMonth = monthVal;
                        }
                    }
                }
                const firstDayOfCurrentMonth = new Date(currentYear, currentMonth, 1);
                eventDateInput.value = formatDateKeyForStorage(firstDayOfCurrentMonth); // 教室長用
                setInitialTargetYearMonth(); // ★ 講師用年月入力の初期化
                
                await loadAdminSettings(); 
                console.log('Initialization complete.'); 
            }
            initialize();
        });
    </script>
    </body>
</html>
