<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シフト提出フォーム (GAS連携テスト)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .time-slot { min-width: 45px; font-size: 0.8rem; }
        .date-label { min-width: 90px; font-size: 0.85rem; writing-mode: horizontal-tb; }
        .sticky-header { position: -webkit-sticky; position: sticky; top: 0; background-color: white; z-index: 10; }
        .sticky-col { position: -webkit-sticky; position: sticky; left: 0; background-color: white; z-index: 5; }
        .selected { background-color: #3b82f6 !important; color: white !important; }
        .disabled-slot { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; font-style: italic; }
        .event-slot { background-color: #fef9c3; color: #713f12; }
        .event-slot.selected { background-color: #2563eb !important; color: white !important; }
        .saturday { color: #3b82f6; }
        .sunday { color: #ef4444; }
        .month-display { text-align: center; font-size: 1.5rem; font-weight: 600; color: #1e40af; padding: 1rem 0; background-color: #e0f2fe; border-bottom: 1px solid #93c5fd; }
        .admin-section { background-color: #f3f4f6; border: 2px dashed #d1d5db; border-radius: 0.5rem; }
        /* ローディングスピナー */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden { display: none; }
    </style>
    <link href="https://script.google.com/macros/s/AKfycbzf00GR1c0TwKdZl4baSLWHjuvOugDGd5c9ZNzLvnpdXoMa3FmQlkLsZGyDXn2ipigr/exec" rel="stylesheet">
</head>
<body class="bg-gray-100 p-2 md:p-4" style="font-family: 'Noto Sans JP', sans-serif;">
    <div class="container mx-auto max-w-5xl bg-white shadow-xl rounded-xl overflow-hidden">
        <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 text-center rounded-t-xl">
            <h1 class="text-2xl md:text-3xl font-bold">シフト提出システム</h1>
            <div id="loadingSpinner" class="loader hidden"></div>
            <p id="loadingStatus" class="text-sm text-blue-200 hidden"></p>
        </header>

        <section id="adminControlSection" class="p-4 md:p-6 admin-section m-4 rounded-lg">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">教室長用 設定パネル</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div>
                    <label for="eventDate" class="block text-sm font-medium text-gray-700">日付:</label>
                    <input type="date" id="eventDate" name="eventDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="eventTimeSlot" class="block text-sm font-medium text-gray-700">時間枠:</label>
                    <select id="eventTimeSlot" name="eventTimeSlot" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">選択してください</option>
                        <option value="全日">全日</option>
                        <option value="1限">1限</option><option value="2限">2限</option><option value="3限">3限</option><option value="4限">4限</option>
                        <option value="5限">5限</option><option value="6限">6限</option><option value="7限">7限</option><option value="8限">8限</option>
                    </select>
                </div>
                <div>
                    <label for="eventType" class="block text-sm font-medium text-gray-700">種別:</label>
                    <select id="eventType" name="eventType" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="講習">講習</option><option value="休講">休講</option><option value="その他">その他</option><option value="クリア">設定クリア</option>
                    </select>
                </div>
                <div>
                    <label for="eventDescription" class="block text-sm font-medium text-gray-700">詳細(任意):</label>
                    <input type="text" id="eventDescription" name="eventDescription" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="例: 数学特別講座">
                </div>
            </div>
            <div class="text-right">
                <button type="button" id="applyEventButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">設定を反映/保存</button>
                <button type="button" id="refreshAdminSettingsButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ml-2">最新の設定を読込</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">※設定はGoogleスプレッドシートに保存されます。</p>
        </section>

        <div id="monthDisplay" class="month-display"></div>

        <div class="p-4 md:p-6">
            <p class="text-gray-700 mb-2 text-sm md:text-base">講師情報と勤務可能なコマをタップしてください。</p>
            <p class="text-xs text-gray-600 mb-6">
                <span class="inline-block w-3 h-3 bg-yellow-100 border border-gray-300 mr-1 align-middle"></span>講習/イベントコマ (選択可)
                <span class="inline-block w-3 h-3 bg-gray-200 border border-gray-300 ml-2 mr-1 align-middle"></span>休講コマ (選択不可)
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-8">
                <div>
                    <label for="instructorName" class="block text-sm font-medium text-gray-800 mb-1">講師氏名:</label>
                    <input type="text" id="instructorName" name="instructorName" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-shadow">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-800 mb-1">担当区分 (文理):</label>
                    <div class="mt-2 flex space-x-4">
                        <label class="inline-flex items-center"><input type="radio" name="subjectType" value="文系" class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500"><span class="ml-2 text-sm text-gray-700">文系</span></label>
                        <label class="inline-flex items-center"><input type="radio" name="subjectType" value="理系" class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500"><span class="ml-2 text-sm text-gray-700">理系</span></label>
                        <label class="inline-flex items-center"><input type="radio" name="subjectType" value="共通" checked class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500"><span class="ml-2 text-sm text-gray-700">共通</span></label>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto pb-4 shadow-md rounded-lg border border-gray-200">
                <table class="min-w-full border-collapse">
                    <thead class="sticky-header bg-gray-100">
                        <tr class="border-b border-gray-300">
                            <th class="sticky-col border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 date-label bg-gray-100">日付</th>
                            <th class="border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">1限</th><th class="border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">2限</th><th class="border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">3限</th><th class="border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">4限</th>
                            <th class="border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">5限</th><th class="border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">6限</th><th class="border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">7限</th><th class="border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">8限</th>
                        </tr>
                    </thead>
                    <tbody id="shiftTableBody" class="bg-white"></tbody>
                </table>
            </div>
            <div class="mt-8">
                <label for="remarks" class="block text-sm font-medium text-gray-800 mb-1">備考:</label>
                <textarea id="remarks" name="remarks" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-shadow" placeholder="例: 〇日は17時まで勤務可能、〇週目は多めに入れます。"></textarea>
            </div>
            <div class="mt-10 mb-6 text-center">
                <button type="button" id="submitShiftButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-10 rounded-lg shadow-lg hover:shadow-xl transition duration-200 ease-in-out transform hover:scale-105">この内容で提出する</button>
            </div>
        </div>
        <footer class="bg-gray-200 p-4 text-center text-xs md:text-sm text-gray-600 rounded-b-xl">
            &copy; <span id="currentYear"></span> Canvas 個別指導塾
        </footer>
    </div>

    <script>
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★ GASのウェブアプリURLをここに設定してください ★
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzf00GR1c0TwKdZl4baSLWHjuvOugDGd5c9ZNzLvnpdXoMa3FmQlkLsZGyDXn2ipigr/exec'; // 例: 'https://script.google.com/macros/s/XXXXXXXXXXXXXXXXXXXXX/exec'
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

        document.addEventListener('DOMContentLoaded', function () {
            const tableBody = document.getElementById('shiftTableBody');
            const monthDisplay = document.getElementById('monthDisplay');
            const currentYearSpan = document.getElementById('currentYear');
            const instructorNameInput = document.getElementById('instructorName');
            const remarksInput = document.getElementById('remarks');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const loadingStatus = document.getElementById('loadingStatus');

            const eventDateInput = document.getElementById('eventDate');
            const eventTimeSlotSelect = document.getElementById('eventTimeSlot');
            const eventTypeSelect = document.getElementById('eventType');
            const eventDescriptionInput = document.getElementById('eventDescription');
            const applyEventButton = document.getElementById('applyEventButton');
            const refreshAdminSettingsButton = document.getElementById('refreshAdminSettingsButton');

            const today = new Date();
            let currentYear = today.getFullYear();
            let currentMonth = today.getMonth();

            // 教室長設定を保持するローカル変数 (GASから取得したものを格納)
            let classroomEvents = {}; 

            function showLoading(message = "処理中...") {
                loadingSpinner.classList.remove('hidden');
                loadingStatus.textContent = message;
                loadingStatus.classList.remove('hidden');
            }

            function hideLoading() {
                loadingSpinner.classList.add('hidden');
                loadingStatus.classList.add('hidden');
            }

            async function fetchFromGAS(action, payload = {}, method = 'GET') {
                if (GAS_WEB_APP_URL === 'YOUR_GAS_WEB_APP_URL' || !GAS_WEB_APP_URL) {
                    alert('GAS_WEB_APP_URLが設定されていません。HTMLファイル内の該当箇所を修正してください。');
                    throw new Error('GAS_WEB_APP_URL is not set.');
                }
                showLoading(method === 'POST' ? 'データを送信中...' : 'データを読込中...');
                try {
                    let url = GAS_WEB_APP_URL;
                    const options = {
                        method: method,
                        mode: 'cors', // CORSを有効に
                        redirect: 'follow',
                    };

                    if (method === 'GET') {
                        const params = new URLSearchParams(payload);
                        params.append('action', action);
                        url += '?' + params.toString();
                    } else if (method === 'POST') {
                        payload.action = action; // actionをペイロードに含める
                        options.body = JSON.stringify(payload);
                        options.headers = {
                            'Content-Type': 'application/json',
                        };
                    }
                    
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`GASへのリクエストに失敗しました。Status: ${response.status}, Message: ${errorText}`);
                    }
                    const result = await response.json();
                    if (result.status === 'error') {
                        throw new Error(`GASエラー: ${result.message}`);
                    }
                    return result;
                } catch (error) {
                    console.error('GAS通信エラー:', error);
                    alert(`エラーが発生しました: ${error.message}`);
                    throw error; // エラーを再スローして呼び出し元で処理できるようにする
                } finally {
                    hideLoading();
                }
            }

            async function loadAdminSettings() {
                try {
                    const result = await fetchFromGAS('getAdminSettings', {}, 'GET');
                    classroomEvents = result.data || {};
                    populateShiftTable(); // 設定を読み込んだ後にテーブルを再描画
                    console.log("教室長設定を読み込みました:", classroomEvents);
                } catch (error) {
                    // エラー処理はfetchFromGAS内で行われる
                    classroomEvents = {}; // エラー時はローカルのclassroomEventsを空にする
                    populateShiftTable(); // 空の状態でテーブルを描画
                }
            }
            
            function formatDateKeyForStorage(date) { // YYYY-MM-DD 形式
                const d = new Date(date);
                const year = d.getFullYear();
                const month = (d.getMonth() + 1).toString().padStart(2, '0');
                const dayVal = d.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${dayVal}`;
            }

            function formatDateForDisplay(date) { // M/D(曜) 形式
                const d = new Date(date);
                const month = d.getMonth() + 1;
                const dayVal = d.getDate();
                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][d.getDay()];
                return `${month}/${dayVal}(${dayOfWeek})`;
            }

            function populateShiftTable() {
                tableBody.innerHTML = '';
                monthDisplay.textContent = `${currentYear}年 ${currentMonth + 1}月`;
                currentYearSpan.textContent = currentYear;
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDateObj = new Date(currentYear, currentMonth, day);
                    const dateKeyForLookup = formatDateKeyForStorage(currentDateObj); // YYYY-MM-DD for lookup
                    const dateForDisplay = formatDateForDisplay(currentDateObj); // M/D(曜) for display

                    const dayOfWeekIndex = currentDateObj.getDay();
                    const row = document.createElement('tr');
                    row.classList.add('border-b', 'border-gray-200');
                    if (dayOfWeekIndex === 0 || dayOfWeekIndex === 6) row.classList.add('bg-gray-50');

                    const dateCell = document.createElement('td');
                    dateCell.classList.add('sticky-col', 'border-r', 'border-gray-300', 'px-2', 'py-3', 'text-xs', 'md:text-sm', 'text-gray-800', 'font-medium', 'date-label', 'text-center');
                    if (dayOfWeekIndex === 0) dateCell.classList.add('sunday');
                    if (dayOfWeekIndex === 6) dateCell.classList.add('saturday');
                    dateCell.classList.add((dayOfWeekIndex === 0 || dayOfWeekIndex === 6) ? 'bg-gray-100' : 'bg-white');
                    dateCell.textContent = dateForDisplay;
                    row.appendChild(dateCell);

                    for (let j = 1; j <= 8; j++) {
                        const timeSlotKey = `${j}限`;
                        const cell = document.createElement('td');
                        cell.classList.add('border-r', 'border-gray-300', 'px-1', 'py-3', 'text-center', 'cursor-pointer', 'time-slot-cell', 'transition-colors', 'duration-150');
                        if (j === 8) cell.classList.remove('border-r');

                        cell.dataset.date = dateForDisplay;
                        cell.dataset.timeSlot = timeSlotKey;
                        
                        const settingId = `${dateKeyForLookup}_${timeSlotKey}`;
                        const allDaySettingId = `${dateKeyForLookup}_全日`;
                        
                        let eventInfo = classroomEvents[settingId];
                        // 全日設定の適用ロジックを調整: 個別設定があればそれを優先、なければ全日設定を参照
                        if (!eventInfo && classroomEvents[allDaySettingId]) {
                            eventInfo = classroomEvents[allDaySettingId];
                        }


                        let originalText = "";
                        if (eventInfo) {
                            cell.dataset.eventType = eventInfo.type;
                            originalText = eventInfo.description ? `${eventInfo.type}(${eventInfo.description})` : eventInfo.type;
                            cell.innerHTML = `<span class="text-xs">${originalText}</span>`;
                            if (eventInfo.type === '休講') {
                                cell.classList.add('disabled-slot');
                                cell.title = `休講: ${eventInfo.description || ''}`;
                            } else {
                                cell.classList.add('event-slot');
                                cell.title = `${eventInfo.type}: ${eventInfo.description || ''}`;
                            }
                        }

                        if (!cell.classList.contains('disabled-slot')) {
                            cell.addEventListener('click', function() {
                                this.classList.toggle('selected');
                                if (this.classList.contains('selected')) {
                                    if (eventInfo) this.innerHTML = `<span class="text-xs">${originalText}</span>`;
                                } else {
                                    if (eventInfo) this.innerHTML = `<span class="text-xs">${originalText}</span>`;
                                    else this.innerHTML = '';
                                }
                            });
                        }
                        row.appendChild(cell);
                    }
                    tableBody.appendChild(row);
                }
            }

            applyEventButton.addEventListener('click', async function() {
                const dateVal = eventDateInput.value; // YYYY-MM-DD
                const timeSlotVal = eventTimeSlotSelect.value;
                const typeVal = eventTypeSelect.value;
                const descriptionVal = eventDescriptionInput.value;

                if (!dateVal || !timeSlotVal) {
                    alert('日付と時間枠を選択してください。');
                    return;
                }
                
                const dateKey = formatDateKeyForStorage(new Date(dateVal)); // YYYY-MM-DD

                // classroomEventsを直接更新するのではなく、GASに送信するデータを作成
                // GAS側で既存のclassroomEventsとマージまたは上書きする
                // ここでは、ローカルのclassroomEventsも更新して即時反映させるが、
                // 本来はGASからのレスポンスで最新の全設定を取得し直すのが堅牢
                
                // 変更対象のIDを作成
                const settingIdBase = `${dateKey}_`;

                if (typeVal === 'クリア') {
                    if (timeSlotVal === '全日') {
                        // 全日クリアの場合、該当日の全時間枠と全日設定をclassroomEventsから削除
                        for (let i = 1; i <= 8; i++) delete classroomEvents[`${settingIdBase}${i}限`];
                        delete classroomEvents[`${settingIdBase}全日`];
                    } else {
                        delete classroomEvents[`${settingIdBase}${timeSlotVal}`];
                    }
                } else {
                    if (timeSlotVal === '全日') {
                        // 全日設定の場合、該当日の個別時間枠設定をクリアし、全日設定を適用
                        for (let i = 1; i <= 8; i++) delete classroomEvents[`${settingIdBase}${i}限`];
                        classroomEvents[`${settingIdBase}全日`] = { type: typeVal, description: descriptionVal };
                    } else {
                        // 個別時間枠設定の場合、該当日の全日設定があればそれを削除し、個別設定を適用
                        delete classroomEvents[`${settingIdBase}全日`];
                        classroomEvents[`${settingIdBase}${timeSlotVal}`] = { type: typeVal, description: descriptionVal };
                    }
                }
                
                try {
                    await fetchFromGAS('saveAdminSettings', { events: classroomEvents }, 'POST');
                    alert('教室長設定をスプレッドシートに保存しました。');
                    populateShiftTable(); // ローカルの変更を反映して再描画
                } catch (error) {
                    // エラー時は、ローカルの変更を元に戻すか、ユーザーに再試行を促す
                    // ここではアラートのみ
                    alert('設定の保存に失敗しました。');
                    await loadAdminSettings(); // 失敗したらサーバーから再読み込み
                }
            });
            
            refreshAdminSettingsButton.addEventListener('click', async function() {
                if (confirm('スプレッドシートから最新の教室長設定を読み込みますか？未保存のローカル変更は失われます。')) {
                    await loadAdminSettings();
                    alert('最新の教室長設定を読み込みました。');
                }
            });


            const submitShiftButton = document.getElementById('submitShiftButton');
            submitShiftButton.addEventListener('click', async function handleSubmit() {
                const instructorName = instructorNameInput.value;
                const subjectTypeElement = document.querySelector('input[name="subjectType"]:checked');
                const subjectType = subjectTypeElement ? subjectTypeElement.value : "";
                const remarks = remarksInput.value;
                const selectedCells = document.querySelectorAll('#shiftTableBody .time-slot-cell.selected');

                if (!instructorName) { alert("講師氏名を入力してください。"); return; }
                if (!subjectType) { alert("担当区分（文理）を選択してください。"); return; }

                let shiftsData = {};
                selectedCells.forEach(cell => {
                    if (cell.classList.contains('disabled-slot')) return;
                    const date = cell.dataset.date; // M/D(曜)
                    const timeSlot = cell.dataset.timeSlot;
                    if (!shiftsData[date]) shiftsData[date] = [];
                    shiftsData[date].push(timeSlot);
                });

                const dataToSubmit = {
                    instructorName: instructorName,
                    subjectType: subjectType,
                    remarks: remarks,
                    shifts: shiftsData,
                };

                try {
                    const result = await fetchFromGAS('submitShift', dataToSubmit, 'POST');
                    alert(result.message || 'シフトが正常に送信されました。');
                    // 成功したらフォームをクリアするなどの処理
                    instructorNameInput.value = '';
                    remarksInput.value = '';
                    selectedCells.forEach(cell => cell.classList.remove('selected')); 
                    // 必要ならテーブルも再描画して選択状態をクリア
                    populateShiftTable();
                } catch (error) {
                    // エラー処理はfetchFromGAS内で行われる
                }
            });

            // 初期化処理
            async function initialize() {
                const urlParams = new URLSearchParams(window.location.search);
                const monthParam = urlParams.get('month'); // YYYY-MM
                if (monthParam) {
                    const parts = monthParam.split('-');
                    if (parts.length === 2) {
                        const year = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1;
                        if (!isNaN(year) && !isNaN(month) && month >= 0 && month <= 11) {
                            currentYear = year;
                            currentMonth = month;
                        }
                    }
                }
                const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
                eventDateInput.value = firstDayOfMonth.toISOString().split('T')[0];
                
                await loadAdminSettings(); // 最初に教室長設定を読み込む
            }

            initialize();
        });
    </script>
</body>
</html>
