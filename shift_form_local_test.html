<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シフト提出フォーム (GAS連携テスト)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .time-slot { min-width: 45px; font-size: 0.8rem; }
        .date-label { min-width: 90px; font-size: 0.85rem; writing-mode: horizontal-tb; }

        /* テーブルヘッダー行のコンテナ(thead)のスティッキー設定 */
        .sticky-header-container { /* thead に適用 */
            position: -webkit-sticky; /* Safari対応 */
            position: sticky;
            top: 0;
            z-index: 20; /* tbodyのセルより手前 */
        }

        /* ヘッダー行内のすべてのセル (th) */
        .sticky-header-container th {
            position: -webkit-sticky; /* Safari対応 */
            position: sticky;
            top: 0; /* ヘッダーセルも個別にtop:0で固定 */
            z-index: 25; 
        }

        /* 日付列のヘッダーセル (左上) - z-indexを最上位に */
        .sticky-header-container > tr > th.sticky-col {
            left: 0; /* 左にも固定 */
            z-index: 30; 
        }

        /* 日付列のボディセル (td) */
        tbody td.sticky-col {
            position: -webkit-sticky; /* Safari対応 */
            position: sticky;
            left: 0;
            z-index: 10; 
        }

        .selected { background-color: #3b82f6 !important; color: white !important; }
        .disabled-slot { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; font-style: italic; }
        .event-slot { background-color: #fef9c3; color: #713f12; }
        .event-slot.selected { background-color: #2563eb !important; color: white !important; }
        .saturday { color: #3b82f6; }
        .sunday { color: #ef4444; }
        .month-display-container { display: flex; align-items: center; justify-content: center; background-color: #e0f2fe; border-bottom: 1px solid #93c5fd; padding: 0.5rem 0; }
        .month-nav-button { background-color: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; margin: 0 1rem; border-radius: 0.375rem; cursor: pointer; font-weight: 500; }
        .month-nav-button:hover { background-color: #2563eb; }
        .month-display { text-align: center; font-size: 1.5rem; font-weight: 600; color: #1e40af; padding: 0.5rem 0; min-width: 150px; }
        .admin-section { background-color: #f3f4f6; border: 2px dashed #d1d5db; border-radius: 0.5rem; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden { display: none; }
        .collapsible-content {
            max-height: 1000px; 
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 1;
        }
        .collapsible-content.collapsed {
            max-height: 0;
            padding-top: 0 !important; 
            padding-bottom: 0 !important; 
            opacity: 0;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 p-2 md:p-4" style="font-family: 'Noto Sans JP', sans-serif;">
    <div class="container mx-auto max-w-5xl bg-white shadow-xl rounded-xl overflow-hidden">
        <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 text-center rounded-t-xl">
            <h1 class="text-2xl md:text-3xl font-bold">シフト提出システム</h1>
            <div id="loadingSpinner" class="loader hidden"></div>
            <p id="loadingStatus" class="text-sm text-blue-200 hidden"></p>
        </header>

        <section id="adminControlSectionWrapper" class="admin-section m-4 rounded-lg">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-semibold text-gray-700">教室長用 設定パネル (<span id="adminPanelCurrentMonthDisplay"></span>)</h2>
                <button id="toggleAdminPanelButton" class="text-sm text-blue-600 hover:text-blue-800 focus:outline-none">
                    <span class="toggle-text">パネルを隠す</span> 
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block toggle-icon transform transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div id="adminControlSectionContent" class="p-4 md:p-6 collapsible-content">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label for="eventDate" class="block text-sm font-medium text-gray-700">日付 (現在のパネル対象月: <span id="eventDateTargetMonthDisplay"></span>):</label>
                        <input type="date" id="eventDate" name="eventDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="eventTimeSlot" class="block text-sm font-medium text-gray-700">時間枠:</label>
                        <select id="eventTimeSlot" name="eventTimeSlot" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">選択してください</option>
                            <option value="全日">全日</option>
                            <option value="1限">1限</option><option value="2限">2限</option><option value="3限">3限</option><option value="4限">4限</option>
                            <option value="5限">5限</option><option value="6限">6限</option><option value="7限">7限</option><option value="8限">8限</option>
                        </select>
                    </div>
                    <div>
                        <label for="eventType" class="block text-sm font-medium text-gray-700">種別:</label>
                        <select id="eventType" name="eventType" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="講習">講習</option><option value="休講">休講</option><option value="その他">その他</option><option value="クリア">設定クリア</option>
                        </select>
                    </div>
                    <div>
                        <label for="eventDescription" class="block text-sm font-medium text-gray-700">詳細(任意):</label>
                        <input type="text" id="eventDescription" name="eventDescription" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="例: 数学特別講座">
                    </div>
                </div>
                <div class="text-right">
                    <button type="button" id="applyEventButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">設定を反映/保存</button>
                    <button type="button" id="refreshAdminSettingsButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ml-2">最新の設定を読込</button>
                </div>
                <p class="text-xs text-gray-500 mt-2">※設定はGoogleスプレッドシートの月別シートに保存されます。</p>
            </div>
        </section>

        <div class="month-display-container">
            <button id="prevMonthButton" class="month-nav-button">&lt; 前月</button>
            <div id="monthDisplay" class="month-display"></div>
            <button id="nextMonthButton" class="month-nav-button">次月 &gt;</button>
        </div>

        <div class="p-4 md:p-6">
            <p class="text-gray-700 mb-2 text-sm md:text-base">講師情報と勤務可能なコマをタップしてください。</p>
            <p class="text-xs text-gray-600 mb-6">
                <span class="inline-block w-3 h-3 bg-yellow-100 border border-gray-300 mr-1 align-middle"></span>講習/イベントコマ (選択可)
                <span class="inline-block w-3 h-3 bg-gray-200 border border-gray-300 ml-2 mr-1 align-middle"></span>休講コマ (選択不可)
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-8">
                <div>
                    <label for="instructorName" class="block text-sm font-medium text-gray-800 mb-1">講師氏名:</label>
                    <input type="text" id="instructorName" name="instructorName" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-shadow">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-800 mb-1">担当区分 (文理):</label>
                    <div class="mt-2 flex space-x-4">
                        <label class="inline-flex items-center"><input type="radio" name="subjectType" value="文系" class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500"><span class="ml-2 text-sm text-gray-700">文系</span></label>
                        <label class="inline-flex items-center"><input type="radio" name="subjectType" value="理系" class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500"><span class="ml-2 text-sm text-gray-700">理系</span></label>
                        <label class="inline-flex items-center"><input type="radio" name="subjectType" value="共通" checked class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500"><span class="ml-2 text-sm text-gray-700">共通</span></label>
                    </div>
                </div>
                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="targetYearMonth" class="block text-sm font-medium text-gray-800 mb-1">対象年月 (シフト表):</label>
                        <input type="month" id="targetYearMonth" name="targetYearMonth" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-shadow">
                    </div>
                    <div class="md:col-span-2">
                         <button type="button" id="loadShiftButton" class="w-full md:w-auto bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out">提出済みシフトを読み込む</button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto pb-4 shadow-md rounded-lg border border-gray-200">
                <table class="min-w-full border-collapse">
                    <thead class="sticky-header-container bg-gray-100">
                        <tr class="border-b border-gray-300">
                            <th class="sticky-col border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 date-label bg-gray-100">日付</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">1限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">2限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">3限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">4限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">5限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">6限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">7限</th>
                            <th class="bg-gray-100 border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">8限</th>
                        </tr>
                    </thead>
                    <tbody id="shiftTableBody" class="bg-white">
                        </tbody>
                </table>
            </div>
            <div class="mt-8">
                <label for="remarks" class="block text-sm font-medium text-gray-800 mb-1">備考:</label>
                <textarea id="remarks" name="remarks" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-shadow" placeholder="例: 〇日は17時まで勤務可能、〇週目は多めに入れます。"></textarea>
            </div>
            <div class="mt-10 mb-6 text-center">
                <button type="button" id="submitShiftButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-10 rounded-lg shadow-lg hover:shadow-xl transition duration-200 ease-in-out transform hover:scale-105">この内容で提出する</button>
                 <p id="submissionStatus" class="text-sm text-gray-600 mt-2 hidden"></p>
            </div>
        </div>
        <footer class="bg-gray-200 p-4 text-center text-xs md:text-sm text-gray-600 rounded-b-xl">
            &copy; <span id="currentYear"></span> Canvas 個別指導塾
        </footer>
    </div>

    <script>
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzf00GR1c0TwKdZl4baSLWHjuvOugDGd5c9ZNzLvnpdXoMa3FmQlkLsZGyDXn2ipigr/exec'; 

        document.addEventListener('DOMContentLoaded', function () {
            const tableBody = document.getElementById('shiftTableBody');
            const monthDisplay = document.getElementById('monthDisplay'); 
            const currentYearSpan = document.getElementById('currentYear');
            const instructorNameInput = document.getElementById('instructorName');
            const remarksInput = document.getElementById('remarks');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const loadingStatus = document.getElementById('loadingStatus');
            const submissionStatus = document.getElementById('submissionStatus'); 

            const eventDateInput = document.getElementById('eventDate');
            const eventTimeSlotSelect = document.getElementById('eventTimeSlot');
            const eventTypeSelect = document.getElementById('eventType');
            const eventDescriptionInput = document.getElementById('eventDescription');
            const applyEventButton = document.getElementById('applyEventButton');
            const refreshAdminSettingsButton = document.getElementById('refreshAdminSettingsButton');

            const prevMonthButton = document.getElementById('prevMonthButton');
            const nextMonthButton = document.getElementById('nextMonthButton');

            const targetYearMonthInput = document.getElementById('targetYearMonth'); 
            const loadShiftButton = document.getElementById('loadShiftButton');

            const toggleAdminPanelButton = document.getElementById('toggleAdminPanelButton');
            const adminPanelContent = document.getElementById('adminControlSectionContent');
            const adminPanelToggleText = toggleAdminPanelButton.querySelector('.toggle-text');
            const adminPanelToggleIcon = toggleAdminPanelButton.querySelector('.toggle-icon');
            const adminPanelCurrentMonthDisplay = document.getElementById('adminPanelCurrentMonthDisplay');
            const eventDateTargetMonthDisplay = document.getElementById('eventDateTargetMonthDisplay');


            const today = new Date();
            let currentYear = today.getFullYear(); 
            let currentMonth = today.getMonth();   
            let classroomEvents = {}; 
            let currentSubmissionId = null; 

            if (toggleAdminPanelButton && adminPanelContent) {
                toggleAdminPanelButton.addEventListener('click', () => {
                    adminPanelContent.classList.toggle('collapsed');
                    updateAdminPanelToggle();
                });
            }

            function updateAdminPanelToggle() { /* ... (変更なし) ... */ }
            function updateAdminPanelMonthDisplay() { /* ... (変更なし) ... */ }
            function showLoading(message = "処理中...") { /* ... (変更なし) ... */ }
            function hideLoading() { /* ... (変更なし) ... */ }
            function formatDateKeyForStorage(dateObj) { /* ... (変更なし) ... */ }
            function setInitialTargetYearMonth() { /* ... (変更なし) ... */ }
            async function changeMonth(monthOffset) { /* ... (変更なし) ... */ }
            prevMonthButton.addEventListener('click', function() { changeMonth(-1); });
            nextMonthButton.addEventListener('click', function() { changeMonth(1); });
            targetYearMonthInput.addEventListener('change', async function() { /* ... (変更なし) ... */ });
            async function fetchFromGAS(action, payload = {}, method = 'GET') { /* ... (変更なし) ... */ }
            async function loadAdminSettings() { /* ... (変更なし) ... */ }
            function formatDateForDisplay(date) { /* ... (変更なし) ... */ }
            function populateShiftTable() { /* ... (変更なし) ... */ }
            applyEventButton.addEventListener('click', async function() { /* ... (変更なし) ... */ });
            refreshAdminSettingsButton.addEventListener('click', async function() { /* ... (変更なし) ... */ });
            loadShiftButton.addEventListener('click', async function() { /* ... (変更なし) ... */ });
            function clearSelectionAndRemarks(clearInstructorInfo = true) { /* ... (変更なし) ... */ }
            
            // ★★★ シフト提出ボタンのイベントリスナー (修正版) ★★★
            const submitShiftButton = document.getElementById('submitShiftButton');
            submitShiftButton.addEventListener('click', async function handleSubmit() {
                console.log('「この内容で提出する」ボタンがクリックされました。');
                const instructorName = instructorNameInput.value;
                const subjectTypeElement = document.querySelector('input[name="subjectType"]:checked');
                const subjectType = subjectTypeElement ? subjectTypeElement.value : "";
                const remarks = remarksInput.value;
                const selectedCells = document.querySelectorAll('#shiftTableBody .time-slot-cell.selected');
                const targetYearMonth = targetYearMonthInput.value; 

                if (!instructorName) { alert("講師氏名を入力してください。"); return; }
                if (!subjectType) { alert("担当区分（文理）を選択してください。"); return; }
                if (!targetYearMonth) { alert("対象年月を選択してください。"); return; } 

                const [year, month] = targetYearMonth.split('-').map(Number); 

                let shiftsData = {};
                selectedCells.forEach(cell => {
                    if (cell.classList.contains('disabled-slot')) return; 
                    
                    const fullDateKey = cell.dataset.fullDate; 
                    const timeSlotKey = cell.dataset.timeSlot; 
                    let slotType = '通常'; 
                    let slotDescription = cell.dataset.eventDescription || '';

                    if (cell.classList.contains('event-slot') && cell.dataset.eventType) {
                        slotType = cell.dataset.eventType;
                    }

                    if (!shiftsData[fullDateKey]) {
                        shiftsData[fullDateKey] = [];
                    }
                    shiftsData[fullDateKey].push({
                        timeSlot: timeSlotKey,
                        type: slotType,
                        description: slotDescription
                    });
                });
                
                console.log('提出データ (shiftsData):', JSON.stringify(shiftsData));

                const dataToSubmit = {
                    submissionId: currentSubmissionId, 
                    year: year, 
                    month: month, 
                    instructorName: instructorName,
                    subjectType: subjectType,
                    remarks: remarks,
                    shifts: shiftsData, 
                };
                console.log('最終提出データ (dataToSubmit):', JSON.stringify(dataToSubmit));
                submissionStatus.textContent = ''; // 前のメッセージをクリア
                submissionStatus.classList.add('hidden'); // メッセージを一旦隠す

                try {
                    const result = await fetchFromGAS('submitShift', dataToSubmit, 'POST');
                    
                    // ★★★ デバッグ用ログ ★★★
                    console.log('GASからのレスポンス (submitShift):', result); 

                    if (result && result.message) { // message プロパティが存在する場合
                        submissionStatus.textContent = result.message;
                        // alert(result.message); // 必要に応じてアラートも表示
                    } else if (result && result.status === 'error' && result.message) { // GAS側でエラーとして message が設定されている場合
                        submissionStatus.textContent = `エラー: ${result.message}`;
                    } else if (result) { // messageはないが、result自体は存在する場合 (GASのレスポンス形式が予期しない場合など)
                        submissionStatus.textContent = '処理は完了しましたが、サーバーからのメッセージ形式が正しくありません。';
                         console.warn('GASからのレスポンスにmessageプロパティがありませんでした:', result);
                    } else { // result自体がnullやundefinedの場合 (fetchFromGASがエラーをthrowせず、nullなどを返した場合 - 通常は考えにくい)
                        submissionStatus.textContent = 'サーバーから予期しない応答がありました。管理者に連絡してください。';
                        console.error('サーバーからの応答が不正です (resultがnullまたはundefined)。');
                    }
                    submissionStatus.classList.remove('hidden'); // メッセージ表示エリアを表示
                    
                    if (result && result.status === 'success') {
                        // 成功したらフォームを初期化
                        clearSelectionAndRemarks(true); 
                        currentSubmissionId = null; 
                    }
                } catch (error) { // fetchFromGAS自体がエラーをスローした場合や、上記の処理中の予期せぬエラー
                    console.error("handleSubmit 内でキャッチされたエラー:", error); 
                    submissionStatus.textContent = `エラーが発生しました: ${error.message || 'シフトの提出処理中に問題が発生しました。'}`;
                    submissionStatus.classList.remove('hidden');
                }
            });
            // ★★★ 修正ここまで ★★★

            async function initialize() { /* ... (変更なし) ... */ }
            initialize();
        });
    </script>
    </body>
</html>
