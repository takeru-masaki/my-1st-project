<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シフト提出フォーム (GAS連携テスト)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .time-slot { min-width: 45px; font-size: 0.8rem; }
        .date-label { min-width: 90px; font-size: 0.85rem; writing-mode: horizontal-tb; }

        /* テーブルヘッダー行のコンテナ(thead)のスティッキー設定 */
        .sticky-header-container { /* thead に適用 */
            position: -webkit-sticky; /* Safari対応 */
            position: sticky;
            top: 0;
            z-index: 20; /* tbodyのセルより手前 */
        }

        /* ヘッダー行内のすべてのセル (th) */
        .sticky-header-container th {
            position: -webkit-sticky; /* Safari対応 */
            position: sticky;
            top: 0; /* ヘッダーセルも個別にtop:0で固定 */
            z-index: 25; 
        }

        /* 日付列のヘッダーセル (左上) - z-indexを最上位に */
        .sticky-header-container > tr > th.sticky-col {
            left: 0; /* 左にも固定 */
            z-index: 30; 
        }

        /* 日付列のボディセル (td) */
        tbody td.sticky-col {
            position: -webkit-sticky; /* Safari対応 */
            position: sticky;
            left: 0;
            z-index: 10; 
        }

        .selected { background-color: #3b82f6 !important; color: white !important; }
        .disabled-slot { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; font-style: italic; }
        .event-slot { background-color: #fef9c3; color: #713f12; }
        .event-slot.selected { background-color: #2563eb !important; color: white !important; }
        .saturday { color: #3b82f6; }
        .sunday { color: #ef4444; }
        .month-display-container { display: flex; align-items: center; justify-content: center; background-color: #e0f2fe; border-bottom: 1px solid #93c5fd; padding: 0.5rem 0; }
        .month-nav-button { background-color: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; margin: 0 1rem; border-radius: 0.375rem; cursor: pointer; font-weight: 500; }
        .month-nav-button:hover { background-color: #2563eb; }
        .month-display { text-align: center; font-size: 1.5rem; font-weight: 600; color: #1e40af; padding: 0.5rem 0; min-width: 150px; }
        .admin-section { background-color: #f3f4f6; border: 2px dashed #d1d5db; border-radius: 0.5rem; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden { display: none; }
        .collapsible-content {
            max-height: 1000px; 
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 1;
        }
        .collapsible-content.collapsed {
            max-height: 0;
            padding-top: 0 !important; 
            padding-bottom: 0 !important; 
            opacity: 0;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 p-2 md:p-4" style="font-family: 'Noto Sans JP', sans-serif;">
    <div class="container mx-auto max-w-5xl bg-white shadow-xl rounded-xl overflow-hidden">
        <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 text-center rounded-t-xl">
            <h1 class="text-2xl md:text-3xl font-bold">シフト提出システム</h1>
            <div id="loadingSpinner" class="loader hidden"></div>
            <p id="loadingStatus" class="text-sm text-blue-200 hidden"></p>
        </header>

        <section id="adminControlSectionWrapper" class="admin-section m-4 rounded-lg">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-semibold text-gray-700">教室長用 設定パネル (<span id="adminPanelCurrentMonthDisplay"></span>)</h2>
                <button id="toggleAdminPanelButton" class="text-sm text-blue-600 hover:text-blue-800 focus:outline-none">
                    <span class="toggle-text">パネルを隠す</span> 
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block toggle-icon transform transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div id="adminControlSectionContent" class="p-4 md:p-6 collapsible-content">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label for="eventDate" class="block text-sm font-medium text-gray-700">日付 (現在のパネル対象月: <span id="eventDateTargetMonthDisplay"></span>):</label>
                        <input type="date" id="eventDate" name="eventDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="eventTimeSlot" class="block text-sm font-medium text-gray-700">時間枠:</label>
                        <select id="eventTimeSlot" name="eventTimeSlot" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">選択してください</option>
                            <option value="全日">全日</option>
                            <option value="1限">1限</option><option value="2限">2限</option><option value="3限">3限</option><option value="4限">4限</option>
                            <option value="5限">5限</option><option value="6限">6限</option><option value="7限">7限</option><option value="8限">8限</option>
                        </select>
                    </div>
                    <div>
                        <label for="eventType" class="block text-sm font-medium text-gray-700">種別:</label>
                        <select id="eventType" name="eventType" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="講習">講習</option><option value="休講">休講</option><option value="その他">その他</option><option value="クリア">設定クリア</option>
                        </select>
                    </div>
                    <div>
                        <label for="eventDescription" class="block text-sm font-medium text-gray-700">詳細(任意):</label>
                        <input type="text" id="eventDescription" name="eventDescription" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="例: 数学特別講座">
                    </div>
                </div>
                <div class="text-right">
                    <button type="button" id="applyEventButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">設定を反映/保存</button>
                    <button type="button" id="refreshAdminSettingsButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ml-2">最新の設定を読込</button>
                </div>
                <p class="text-xs text-gray-500 mt-2">※設定はGoogleスプレッドシートの月別シートに保存されます。</p>
            </div>
        </section>

        <div class="month-display-container">
            <button id="prevMonthButton" class="month-nav-button">&lt; 前月</button>
            <div id="monthDisplay" class="month-display"></div>
            <button id="nextMonthButton" class="month-nav-button">次月 &gt;</button>
        </div>

        <div class="p-4 md:p-6">
            <p class="text-gray-700 mb-2 text-sm md:text-base">講師情報と勤務可能なコマをタップしてください。</p>
            <p class="text-xs text-gray-600 mb-6">
                <span class="inline-block w-3 h-3 bg-yellow-100 border border-gray-300 mr-1 align-middle"></span>講習/イベントコマ (選択可)
                <span class="inline-block w-3 h-3 bg-gray-200 border border-gray-300 ml-2 mr-1 align-middle"></span>休講コマ (選択不可)
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-8">
                <div>
                    <label for="instructorName" class="block text-sm font-medium text-gray-800 mb-1">講師氏名:</label>
                    <input type="text" id="instructorName" name="instructorName" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-shadow">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-800 mb-1">担当区分 (文理):</label>
                    <div class="mt-2 flex space-x-4">
                        <label class="inline-flex items-center"><input type="radio" name="subjectType" value="文系" class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500"><span class="ml-2 text-sm text-gray-700">文系</span></label>
                        <label class="inline-flex items-center"><input type="radio" name="subjectType" value="理系" class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500"><span class="ml-2 text-sm text-gray-700">理系</span></label>
                        <label class="inline-flex items-center"><input type="radio" name="subjectType" value="共通" checked class="form-radio h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500"><span class="ml-2 text-sm text-gray-700">共通</span></label>
                    </div>
                </div>
                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="targetYearMonth" class="block text-sm font-medium text-gray-800 mb-1">対象年月 (シフト表):</label>
                        <input type="month" id="targetYearMonth" name="targetYearMonth" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-shadow">
                    </div>
                    <div class="md:col-span-2">
                         <button type="button" id="loadShiftButton" class="w-full md:w-auto bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out">提出済みシフトを読み込む</button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto pb-4 shadow-md rounded-lg border border-gray-200">
                <table class="min-w-full border-collapse">
                    <thead class="sticky-header-container bg-gray-100">
                        <tr class="border-b border-gray-300">
                            <th class="sticky-col border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 date-label bg-gray-100">日付</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">1限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">2限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">3限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">4限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">5限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">6限</th>
                            <th class="bg-gray-100 border-r border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">7限</th>
                            <th class="bg-gray-100 border-gray-300 px-2 py-3 text-xs md:text-sm font-semibold text-gray-700 time-slot">8限</th>
                        </tr>
                    </thead>
                    <tbody id="shiftTableBody" class="bg-white">
                        </tbody>
                </table>
            </div>
            <div class="mt-8">
                <label for="remarks" class="block text-sm font-medium text-gray-800 mb-1">備考:</label>
                <textarea id="remarks" name="remarks" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition-shadow" placeholder="例: 〇日は17時まで勤務可能、〇週目は多めに入れます。"></textarea>
            </div>
            <div class="mt-10 mb-6 text-center">
                <button type="button" id="submitShiftButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-10 rounded-lg shadow-lg hover:shadow-xl transition duration-200 ease-in-out transform hover:scale-105">この内容で提出する</button>
                 <p id="submissionStatus" class="text-sm text-gray-600 mt-2 hidden"></p>
            </div>
        </div>
        <footer class="bg-gray-200 p-4 text-center text-xs md:text-sm text-gray-600 rounded-b-xl">
            &copy; <span id="currentYear"></span> Canvas 個別指導塾
        </footer>
    </div>

    <script>
        // GAS Web App URL (Replace with your actual URL)
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzf00GR1c0TwKdZl4baSLWHjuvOugDGd5c9ZNzLvnpdXoMa3FmQlkLsZGyDXn2ipigr/exec'; 

        document.addEventListener('DOMContentLoaded', function () {
            // Get DOM elements
            const tableBody = document.getElementById('shiftTableBody');
            const monthDisplay = document.getElementById('monthDisplay'); 
            const currentYearSpan = document.getElementById('currentYear');
            const instructorNameInput = document.getElementById('instructorName');
            const remarksInput = document.getElementById('remarks');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const loadingStatus = document.getElementById('loadingStatus');
            const submissionStatus = document.getElementById('submissionStatus'); 

            // Admin panel elements
            const eventDateInput = document.getElementById('eventDate');
            const eventTimeSlotSelect = document.getElementById('eventTimeSlot');
            const eventTypeSelect = document.getElementById('eventType');
            const eventDescriptionInput = document.getElementById('eventDescription');
            const applyEventButton = document.getElementById('applyEventButton');
            const refreshAdminSettingsButton = document.getElementById('refreshAdminSettingsButton');

            // Month navigation elements
            const prevMonthButton = document.getElementById('prevMonthButton');
            const nextMonthButton = document.getElementById('nextMonthButton');

            // Instructor shift elements
            const targetYearMonthInput = document.getElementById('targetYearMonth'); 
            const loadShiftButton = document.getElementById('loadShiftButton');

            // Admin panel toggle elements
            const toggleAdminPanelButton = document.getElementById('toggleAdminPanelButton');
            const adminPanelContent = document.getElementById('adminControlSectionContent');
            const adminPanelToggleText = toggleAdminPanelButton.querySelector('.toggle-text');
            const adminPanelToggleIcon = toggleAdminPanelButton.querySelector('.toggle-icon');
            const adminPanelCurrentMonthDisplay = document.getElementById('adminPanelCurrentMonthDisplay');
            const eventDateTargetMonthDisplay = document.getElementById('eventDateTargetMonthDisplay');

            // Initialize state variables
            const today = new Date();
            let currentYear = today.getFullYear(); 
            let currentMonth = today.getMonth();   // 0-indexed (January is 0)
            let classroomEvents = {}; // Holds admin settings for the current month
            let currentSubmissionId = null; // Holds the ID of the currently loaded shift for updates

            // --- Admin Panel Toggle Functionality ---
            if (toggleAdminPanelButton && adminPanelContent) {
                adminPanelContent.classList.add('collapsed'); // 初期状態で隠す場合
                updateAdminPanelToggle(); // 初期状態で隠す場合はこちらも呼ぶ

                toggleAdminPanelButton.addEventListener('click', () => {
                    adminPanelContent.classList.toggle('collapsed');
                    updateAdminPanelToggle();
                });
            }

            function updateAdminPanelToggle() {
                if (!adminPanelContent || !adminPanelToggleText || !adminPanelToggleIcon) return;
                if (adminPanelContent.classList.contains('collapsed')) {
                    adminPanelToggleText.textContent = 'パネルを開く'; // Open panel
                    adminPanelToggleIcon.style.transform = 'rotate(180deg)';
                } else {
                    adminPanelToggleText.textContent = 'パネルを隠す'; // Hide panel
                    adminPanelToggleIcon.style.transform = 'rotate(0deg)';
                }
            }
            
            // --- Update Admin Panel Month Display ---
            function updateAdminPanelMonthDisplay() {
                const displayYear = currentYear;
                const displayMonth = currentMonth + 1; // 1-indexed for display
                const monthStr = `${displayYear}年 ${displayMonth}月`; // Year Month
                if (adminPanelCurrentMonthDisplay) adminPanelCurrentMonthDisplay.textContent = monthStr;
                if (eventDateTargetMonthDisplay) eventDateTargetMonthDisplay.textContent = monthStr;
                const firstDayOfCurrentCalendarMonth = new Date(currentYear, currentMonth, 1);
                eventDateInput.value = formatDateKeyForStorage(firstDayOfCurrentCalendarMonth);
            }

            // --- Loading Indicator ---
            function showLoading(message = "処理中...") { // Processing...
                loadingSpinner.classList.remove('hidden');
                loadingStatus.textContent = message;
                loadingStatus.classList.remove('hidden');
            }

            function hideLoading() {
                loadingSpinner.classList.add('hidden');
                loadingStatus.classList.add('hidden');
            }
            
            // --- Date Formatting ---
            function formatDateKeyForStorage(dateObj) { 
                if (!(dateObj instanceof Date) || isNaN(dateObj)) { 
                    console.error("formatDateKeyForStorage: input is not a valid Date object", dateObj);
                    const d = new Date(); 
                    return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
                }
                return `${dateObj.getFullYear()}-${(dateObj.getMonth() + 1).toString().padStart(2, '0')}-${dateObj.getDate().toString().padStart(2, '0')}`;
            }

            function formatDateForDisplay(date) { 
                const d = new Date(date);
                const monthVal = d.getMonth() + 1; 
                const dayVal = d.getDate();
                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][d.getDay()]; // Sun, Mon, Tue, Wed, Thu, Fri, Sat
                return `${monthVal}/${dayVal}(${dayOfWeek})`;
            }

            // --- Set Initial Target Year/Month for Instructor ---
            function setInitialTargetYearMonth() {
                targetYearMonthInput.value = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}`;
            }

            // --- Change Calendar Month ---
            async function changeMonth(monthOffset) {
                currentMonth += monthOffset;
                if (currentMonth < 0) {
                    currentMonth = 11; // December (0-indexed)
                    currentYear--;
                } else if (currentMonth > 11) {
                    currentMonth = 0; // January (0-indexed)
                    currentYear++;
                }
                monthDisplay.textContent = `${currentYear}年 ${currentMonth + 1}月`; // Year Month
                updateAdminPanelMonthDisplay(); 
                setInitialTargetYearMonth();    

                await loadAdminSettings(); 
                
                clearSelectionAndRemarks(); 
                submissionStatus.classList.add('hidden'); 
                currentSubmissionId = null; 
            }

            prevMonthButton.addEventListener('click', function() { changeMonth(-1); });
            nextMonthButton.addEventListener('click', function() { changeMonth(1); });

            // --- Handle Instructor's Target Year/Month Change ---
            targetYearMonthInput.addEventListener('change', async function() {
                const [year, month] = this.value.split('-').map(Number);
                if (year && month && (year !== currentYear || (month -1) !== currentMonth)) {
                    currentYear = year;
                    currentMonth = month - 1; 
                    
                    monthDisplay.textContent = `${currentYear}年 ${currentMonth + 1}月`; // Year Month
                    updateAdminPanelMonthDisplay(); 
                    
                    await loadAdminSettings(); 
                    clearSelectionAndRemarks(); 
                    submissionStatus.classList.add('hidden'); 
                    currentSubmissionId = null; 
                }
            });

            // --- Fetch Data from GAS ---
            async function fetchFromGAS(action, payload = {}, method = 'GET') {
                console.log(`fetchFromGAS called. Action: ${action}, Method: ${method}, URL: ${GAS_WEB_APP_URL}`);
                if (method === 'POST') {
                    console.log('Payload for POST:', JSON.stringify(payload));
                }

                // Simulate GAS response if URL is not set (for local testing without GAS deployment)
                if (GAS_WEB_APP_URL === 'YOUR_GAS_WEB_APP_URL_HERE' || !GAS_WEB_APP_URL ) {
                    console.warn('GAS_WEB_APP_URL is a placeholder or not set. Simulating GAS response for preview.');
                     if (action === 'getAdminSettings' || action === 'loadShift') { 
                        hideLoading();
                        if (action === 'getAdminSettings') return Promise.resolve({ status: 'success', data: {} });
                        return Promise.resolve({ status: 'success', data: null }); 
                    }
                    if (action === 'submitShift' || action === 'saveAdminSettings') {
                        hideLoading();
                        return Promise.resolve({ status: 'success', message: 'データはプレビューモードのため送信されませんが、処理はシミュレートされました。' }); // Data not sent in preview mode, but process simulated.
                    }
                }

                showLoading(method === 'POST' ? 'データを送信中...' : 'データを読込中...'); // Sending data... / Loading data...
                try {
                    let url = GAS_WEB_APP_URL;
                    const options = {
                        method: method,
                        mode: 'cors', 
                        redirect: 'follow',
                    };

                    if (method === 'GET') {
                        const params = new URLSearchParams(payload); 
                        params.append('action', action);
                        url += '?' + params.toString();
                        console.log('GET request to:', url);
                    } else if (method === 'POST') {
                        payload.action = action; 
                        options.body = JSON.stringify(payload); 
                        options.headers = {
                            'Content-Type': 'text/plain;charset=UTF-8',
                        };
                        console.log('POST request to:', url, 'with options:', options);
                    }
                    
                    const response = await fetch(url, options);
                    console.log('Fetch response status:', response.status, 'Status text:', response.statusText);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Fetch response error text:', errorText); 
                        throw new Error(`GASへのリクエストに失敗しました。Status: ${response.status}, Message: ${errorText}`); // Request to GAS failed.
                    }
                    const responseText = await response.text();
                    console.log('Raw response text from GAS:', responseText);
                    try {
                        const result = JSON.parse(responseText);
                        console.log('Fetch result from GAS (parsed JSON):', result); 
                        if (result.status === 'error') {
                            throw new Error(`GASエラー: ${result.message}`); // GAS Error
                        }
                        return result;
                    } catch (e) {
                        console.error("Failed to parse GAS response as JSON:", e);
                        throw new Error("GASからの応答がJSON形式ではありません: " + responseText); // Response from GAS is not in JSON format
                    }
                } catch (error) {
                    console.error('GAS通信エラー (fetchFromGAS catch block):', error); // GAS communication error
                    alert(`エラーが発生しました: ${error.message}`); // An error occurred
                    throw error; 
                } finally {
                    hideLoading();
                }
            }
            
            // --- Load Admin Settings ---
            async function loadAdminSettings() {
                try {
                    const result = await fetchFromGAS('getAdminSettings', { 
                        year: currentYear,        
                        month: currentMonth + 1   
                    }, 'GET');
                    classroomEvents = result.data || {}; 
                    populateShiftTable(); 
                    console.log(`教室長設定を読み込みました (${currentYear}年${currentMonth + 1}月):`, classroomEvents); // Admin settings loaded (Year Month)
                } catch (error) {
                    console.error("loadAdminSettings でエラー:", error); // Error in loadAdminSettings
                    classroomEvents = {}; 
                    populateShiftTable(); 
                }
            }
            
            // --- Populate Shift Table ---
            function populateShiftTable() {
                tableBody.innerHTML = '';
                // monthDisplay.textContent is set in changeMonth and targetYearMonthInput listener
                currentYearSpan.textContent = currentYear;
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDateObj = new Date(currentYear, currentMonth, day); 
                    const dateKeyForLookup = formatDateKeyForStorage(currentDateObj); 
                    const dateForDisplay = formatDateForDisplay(currentDateObj); 

                    const dayOfWeekIndex = currentDateObj.getDay();
                    const row = document.createElement('tr');
                    row.classList.add('border-b', 'border-gray-200');
                    if (dayOfWeekIndex === 0 || dayOfWeekIndex === 6) row.classList.add('bg-gray-50');

                    const dateCell = document.createElement('td');
                    dateCell.classList.add('sticky-col', 'border-r', 'border-gray-300', 'px-2', 'py-3', 'text-xs', 'md:text-sm', 'text-gray-800', 'font-medium', 'date-label', 'text-center');
                    if (dayOfWeekIndex === 0) dateCell.classList.add('sunday');
                    if (dayOfWeekIndex === 6) dateCell.classList.add('saturday');
                    dateCell.classList.add((dayOfWeekIndex === 0 || dayOfWeekIndex === 6) ? 'bg-gray-50' : 'bg-white'); 
                    dateCell.textContent = dateForDisplay;
                    row.appendChild(dateCell);

                    for (let j = 1; j <= 8; j++) { // 8 time slots
                        const timeSlotKey = `${j}限`; // Slot X
                        const cell = document.createElement('td');
                        cell.classList.add('border-r', 'border-gray-300', 'px-1', 'py-3', 'text-center', 'cursor-pointer', 'time-slot-cell', 'transition-colors', 'duration-150');
                        if (j === 8) cell.classList.remove('border-r'); 

                        cell.dataset.date = dateForDisplay; 
                        cell.dataset.fullDate = dateKeyForLookup; 
                        cell.dataset.timeSlot = timeSlotKey; 
                        
                        const settingId = `${dateKeyForLookup}_${timeSlotKey}`; 
                        const allDaySettingId = `${dateKeyForLookup}_全日`; // All day
                        
                        let eventInfo = classroomEvents[settingId];
                        if (!eventInfo && classroomEvents[allDaySettingId]) {
                            eventInfo = classroomEvents[allDaySettingId];
                        }

                        let originalText = "";
                        if (eventInfo) {
                            cell.dataset.eventType = eventInfo.type;
                            cell.dataset.eventDescription = eventInfo.description || ''; 
                            originalText = eventInfo.description ? `${eventInfo.type}(${eventInfo.description})` : eventInfo.type;
                            cell.innerHTML = `<span class="text-xs">${originalText}</span>`;
                            if (eventInfo.type === '休講') { // Closed
                                cell.classList.add('disabled-slot');
                                cell.title = `休講: ${eventInfo.description || ''}`; // Closed
                            } else {
                                cell.classList.add('event-slot');
                                cell.title = `${eventInfo.type}: ${eventInfo.description || ''}`;
                            }
                        }

                        if (!cell.classList.contains('disabled-slot')) {
                            cell.addEventListener('click', function() {
                                this.classList.toggle('selected');
                                if (this.classList.contains('selected')) {
                                    if (eventInfo) this.innerHTML = `<span class="text-xs">${originalText}</span>`; 
                                } else {
                                    if (eventInfo) this.innerHTML = `<span class="text-xs">${originalText}</span>`; 
                                    else this.innerHTML = ''; 
                                }
                            });
                        }
                        row.appendChild(cell);
                    }
                    tableBody.appendChild(row);
                }
            }

            // --- Admin Panel: Apply Event Button ---
            applyEventButton.addEventListener('click', async function() {
                console.log('「設定を反映/保存」ボタンがクリックされました。'); // "Apply/Save Settings" button clicked.
                const dateVal = eventDateInput.value; 
                const timeSlotVal = eventTimeSlotSelect.value;
                const typeVal = eventTypeSelect.value;
                const descriptionVal = eventDescriptionInput.value;

                if (!dateVal || !timeSlotVal) {
                    alert('日付と時間枠を選択してください。'); // Please select date and time slot.
                    return;
                }
                
                const eventDateObj = new Date(dateVal);
                const targetAdminYear = eventDateObj.getFullYear();
                const targetAdminMonth = eventDateObj.getMonth() + 1; 

                if (targetAdminYear !== currentYear || targetAdminMonth !== (currentMonth + 1)) {
                    if (!confirm(`教室長設定の日付 (${targetAdminYear}年${targetAdminMonth}月) が、現在表示中のカレンダー (${currentYear}年${currentMonth+1}月) と異なります。\n${targetAdminYear}年${targetAdminMonth}月の設定として保存しますか？`)) { // Admin setting date (Year Month) differs from current calendar display (Year Month). Save as settings for (Year Month)?
                        return;
                    }
                }

                const dateKeyForEvent = formatDateKeyForStorage(eventDateObj); 
                let updatedEventsForGAS = JSON.parse(JSON.stringify(classroomEvents)); 
                const settingIdBase = `${dateKeyForEvent}_`; 

                if (typeVal === 'クリア') { // Clear
                    if (timeSlotVal === '全日') { // All day
                        for (let i = 1; i <= 8; i++) delete updatedEventsForGAS[`${settingIdBase}${i}限`]; // Slot X
                        delete updatedEventsForGAS[`${settingIdBase}全日`]; // All day
                    } else {
                        delete updatedEventsForGAS[`${settingIdBase}${timeSlotVal}`];
                    }
                } else {
                    if (timeSlotVal === '全日') { // All day
                        for (let i = 1; i <= 8; i++) delete updatedEventsForGAS[`${settingIdBase}${i}限`]; // Slot X
                        updatedEventsForGAS[`${settingIdBase}全日`] = { type: typeVal, description: descriptionVal }; // All day
                    } else {
                        delete updatedEventsForGAS[`${settingIdBase}全日`]; // All day
                        updatedEventsForGAS[`${settingIdBase}${timeSlotVal}`] = { type: typeVal, description: descriptionVal };
                    }
                }
                
                console.log(`GASに送信する教室長設定 (${targetAdminYear}年${targetAdminMonth}月):`, JSON.stringify(updatedEventsForGAS)); // Admin settings to send to GAS (Year Month)
                try {
                    const result = await fetchFromGAS('saveAdminSettings', { 
                        events: updatedEventsForGAS, 
                        year: targetAdminYear, 
                        month: targetAdminMonth 
                    }, 'POST'); 
                    alert(result.message || `教室長設定 (${targetAdminYear}年${targetAdminMonth}月) を保存しました。`); // Admin settings (Year Month) saved.
                    await loadAdminSettings(); 
                } catch (error) {
                    console.error("applyEventButtonクリック処理でのエラー:", error); // Error in applyEventButton click process
                    await loadAdminSettings(); 
                }
            });
            
            // --- Admin Panel: Refresh Admin Settings Button ---
            refreshAdminSettingsButton.addEventListener('click', async function() {
                if (confirm(`${currentYear}年${currentMonth + 1}月の最新の教室長設定をスプレッドシートから読み込みますか？\n未保存のローカル変更は失われます。`)) { // Load latest admin settings for (Year Month) from spreadsheet? Unsaved local changes will be lost.
                    await loadAdminSettings(); 
                    alert(`${currentYear}年${currentMonth + 1}月の最新の教室長設定を読み込みました。`); // Loaded latest admin settings for (Year Month).
                }
            });

            // --- Load Submitted Shift Button (with enhanced logging and checks) ---
            loadShiftButton.addEventListener('click', async function() {
                const instructorName = instructorNameInput.value;
                const targetYearMonth = targetYearMonthInput.value; 

                if (!instructorName) {
                    alert("講師氏名を入力してください。"); // Please enter instructor name.
                    return;
                }
                if (!targetYearMonth) {
                    alert("対象年月を選択してください。"); // Please select target year/month.
                    return;
                }

                const [year, month] = targetYearMonth.split('-').map(Number);
                console.log(`[loadShift] Attempting to load shift for: ${instructorName}, Year: ${year}, Month: ${month}`);

                try {
                    submissionStatus.textContent = ''; // Clear previous message
                    submissionStatus.classList.add('hidden'); 
                    currentSubmissionId = null; // Reset submission ID before loading

                    const result = await fetchFromGAS('loadShift', {
                        instructorName: instructorName,
                        year: year,
                        month: month 
                    }, 'GET');

                    console.log('[loadShift] GAS Response (loadShift):', JSON.stringify(result, null, 2));

                    if (result && result.status === 'success' && result.data) { 
                        const shiftData = result.data;
                        console.log('[loadShift] Loaded shift data from GAS:', shiftData);
                        
                        instructorNameInput.value = shiftData.instructorName || instructorName; 
                        const subjectRadio = document.querySelector(`input[name="subjectType"][value="${shiftData.subjectType}"]`);
                        if (subjectRadio) subjectRadio.checked = true;
                        else { 
                            document.querySelector('input[name="subjectType"][value="共通"]').checked = true; // Common
                            console.warn(`[loadShift] Subject type "${shiftData.subjectType}" not found in radio buttons. Defaulted to "共通".`); // Common
                        }
                        remarksInput.value = shiftData.remarks || '';
                        
                        currentSubmissionId = shiftData.submissionId || null; 
                        console.log('[loadShift] Set currentSubmissionId to:', currentSubmissionId);

                        document.querySelectorAll('#shiftTableBody .time-slot-cell.selected').forEach(cell => {
                            cell.classList.remove('selected');
                            const eventType = cell.dataset.eventType;
                            const eventDesc = cell.dataset.eventDescription;
                            if (eventType) {
                                cell.innerHTML = `<span class="text-xs">${eventDesc ? `${eventType}(${eventDesc})` : eventType}</span>`;
                            } else {
                                cell.innerHTML = '';
                            }
                        });

                        if (shiftData.shifts && typeof shiftData.shifts === 'object') { 
                            Object.entries(shiftData.shifts).forEach(([dateStr, timeSlots]) => {
                                if (Array.isArray(timeSlots)) { 
                                    timeSlots.forEach(slot => {
                                        if (slot && slot.timeSlot) { 
                                            const cell = document.querySelector(`#shiftTableBody .time-slot-cell[data-full-date="${dateStr}"][data-time-slot="${slot.timeSlot}"]`);
                                            if (cell && !cell.classList.contains('disabled-slot')) {
                                                cell.classList.add('selected');
                                                const eventType = cell.dataset.eventType;
                                                const eventDesc = cell.dataset.eventDescription;
                                                if (eventType) { 
                                                    cell.innerHTML = `<span class="text-xs">${eventDesc ? `${eventType}(${eventDesc})` : eventType}</span>`;
                                                }
                                            } else if (!cell) {
                                                console.warn(`[loadShift] Cell not found for date: ${dateStr}, slot: ${slot.timeSlot}`);
                                            }
                                        } else {
                                            console.warn(`[loadShift] Invalid slot data for date ${dateStr}:`, slot);
                                        }
                                    });
                                } else {
                                     console.warn(`[loadShift] timeSlots for date ${dateStr} is not an array:`, timeSlots);
                                }
                            });
                        } else {
                            console.warn('[loadShift] shiftData.shifts is missing or not an object:', shiftData.shifts);
                        }
                        submissionStatus.textContent = '提出済みのシフトを読み込みました。修正して再提出できます。'; // Loaded submitted shift. You can modify and resubmit.
                        submissionStatus.classList.remove('hidden');
                        // alert('提出済みのシフトを読み込みました。'); // Loaded submitted shift.

                    } else if (result && result.status === 'success' && !result.data) { 
                        submissionStatus.textContent = '指定された年月に提出済みのシフトはありませんでした。新規に作成できます。'; // No submitted shift for the specified year/month. You can create a new one.
                        submissionStatus.classList.remove('hidden');
                        // alert('提出済みのシフトはありませんでした。'); // No submitted shift found.
                        clearSelectionAndRemarks(false); 
                        currentSubmissionId = null; 
                        console.log('[loadShift] No existing shift found. currentSubmissionId set to null.');
                    } else { 
                        submissionStatus.textContent = `エラー: ${result ? result.message : 'シフトの読み込みに失敗しました。サーバーからの応答が不正です。'}`; // Error: Shift loading failed. Invalid response from server.
                        submissionStatus.classList.remove('hidden');
                        console.error('[loadShift] Failed to load shift. GAS Response:', result);
                        currentSubmissionId = null; 
                    }
                } catch (error) {
                    console.error("[loadShift] Error during loadShiftButton click:", error);
                    alert('シフトの読み込み中にエラーが発生しました。'); // Error occurred while loading shift.
                    submissionStatus.textContent = 'シフトの読み込み中にエラーが発生しました。'; // Error occurred while loading shift.
                    submissionStatus.classList.remove('hidden');
                    currentSubmissionId = null; 
                }
            });
            
            // --- Clear Selections and Remarks ---
            function clearSelectionAndRemarks(clearInstructorInfo = true) {
                document.querySelectorAll('#shiftTableBody .time-slot-cell.selected').forEach(cell => {
                    cell.classList.remove('selected');
                    const eventType = cell.dataset.eventType;
                    const eventDesc = cell.dataset.eventDescription;
                    if (eventType) {
                        cell.innerHTML = `<span class="text-xs">${eventDesc ? `${eventType}(${eventDesc})` : eventType}</span>`;
                    } else {
                        cell.innerHTML = '';
                    }
                });
                remarksInput.value = '';
                if (clearInstructorInfo) {
                    instructorNameInput.value = '';
                    document.querySelector('input[name="subjectType"][value="共通"]').checked = true; // Common
                }
            }
            
            // --- Submit Shift Button ---
            const submitShiftButton = document.getElementById('submitShiftButton');
            submitShiftButton.addEventListener('click', async function handleSubmit() {
                console.log('「この内容で提出する」ボタンがクリックされました。'); // "Submit with this content" button clicked.
                const instructorName = instructorNameInput.value;
                const subjectTypeElement = document.querySelector('input[name="subjectType"]:checked');
                const subjectType = subjectTypeElement ? subjectTypeElement.value : "";
                const remarks = remarksInput.value;
                const selectedCells = document.querySelectorAll('#shiftTableBody .time-slot-cell.selected');
                const targetYearMonth = targetYearMonthInput.value; 

                if (!instructorName) { alert("講師氏名を入力してください。"); return; } // Please enter instructor name.
                if (!subjectType) { alert("担当区分（文理）を選択してください。"); return; } // Please select subject type (Arts/Science).
                if (!targetYearMonth) { alert("対象年月を選択してください。"); return; } // Please select target year/month.

                const [year, month] = targetYearMonth.split('-').map(Number); 

                let shiftsData = {};
                selectedCells.forEach(cell => {
                    if (cell.classList.contains('disabled-slot')) return; 
                    
                    const fullDateKey = cell.dataset.fullDate; 
                    const timeSlotKey = cell.dataset.timeSlot; 
                    let slotType = '通常'; // Normal
                    let slotDescription = cell.dataset.eventDescription || '';

                    if (cell.classList.contains('event-slot') && cell.dataset.eventType) {
                        slotType = cell.dataset.eventType;
                    }

                    if (!shiftsData[fullDateKey]) {
                        shiftsData[fullDateKey] = [];
                    }
                    shiftsData[fullDateKey].push({
                        timeSlot: timeSlotKey,
                        type: slotType,
                        description: slotDescription
                    });
                });
                
                console.log('提出データ (shiftsData):', JSON.stringify(shiftsData)); // Submission data

                const dataToSubmit = {
                    submissionId: currentSubmissionId, 
                    year: year, 
                    month: month, 
                    instructorName: instructorName,
                    subjectType: subjectType,
                    remarks: remarks,
                    shifts: shiftsData, 
                };
                console.log('最終提出データ (dataToSubmit):', JSON.stringify(dataToSubmit)); // Final submission data
                submissionStatus.textContent = ''; 
                submissionStatus.classList.add('hidden'); 

                try {
                    const result = await fetchFromGAS('submitShift', dataToSubmit, 'POST');
                    
                    console.log('GASからのレスポンス (submitShift):', result); // Response from GAS

                    if (result && result.message) { 
                        submissionStatus.textContent = result.message;
                    } else if (result && result.status === 'error' && result.message) { 
                        submissionStatus.textContent = `エラー: ${result.message}`; // Error:
                    } else if (result) { 
                        submissionStatus.textContent = '処理は完了しましたが、サーバーからのメッセージ形式が正しくありません。'; // Process completed, but server message format is incorrect.
                         console.warn('GASからのレスポンスにmessageプロパティがありませんでした:', result); // message property was missing in response from GAS
                    } else { 
                        submissionStatus.textContent = 'サーバーから予期しない応答がありました。管理者に連絡してください。'; // Unexpected response from server. Please contact administrator.
                        console.error('サーバーからの応答が不正です (resultがnullまたはundefined)。'); // Invalid response from server (result is null or undefined).
                    }
                    submissionStatus.classList.remove('hidden'); 
                    
                    if (result && result.status === 'success') {
                        clearSelectionAndRemarks(true); 
                        currentSubmissionId = null; 
                    }
                } catch (error) { 
                    console.error("handleSubmit 内でキャッチされたエラー:", error); // Error caught in handleSubmit
                    submissionStatus.textContent = `エラーが発生しました: ${error.message || 'シフトの提出処理中に問題が発生しました。'}`; // An error occurred: / Problem occurred during shift submission process.
                    submissionStatus.classList.remove('hidden');
                }
            });

            // --- Initialize Application ---
            async function initialize() {
                console.log('Initializing application...'); 
                const urlParams = new URLSearchParams(window.location.search);
                const monthParam = urlParams.get('month'); 
                if (monthParam) {
                    const parts = monthParam.split('-');
                    if (parts.length === 2) {
                        const year = parseInt(parts[0]);
                        const monthVal = parseInt(parts[1]) - 1; 
                        if (!isNaN(year) && !isNaN(monthVal) && monthVal >= 0 && monthVal <= 11) {
                            currentYear = year;
                            currentMonth = monthVal;
                        }
                    }
                }
                
                monthDisplay.textContent = `${currentYear}年 ${currentMonth + 1}月`; // Year Month
                updateAdminPanelMonthDisplay(); 
                setInitialTargetYearMonth();    
                
                await loadAdminSettings(); 
                updateAdminPanelToggle(); 
                console.log('Initialization complete.'); 
            }
            initialize();
        });
    </script>
    </body>
</html>
